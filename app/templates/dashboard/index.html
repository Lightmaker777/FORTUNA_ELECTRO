<!-- app/templates/dashboard/index.html -->
{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index_style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/projects_view.css') }}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<div class="container-fluid py-4">
    <!-- Dashboard Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <div class="position-relative">
            <div class="dashboard-heading-decoration"></div>
            <h4 class="fw-bold mb-1 display-5 position-relative">Alles Watt ihr Volt</h4>
            <p class="text-muted mb-0 lead"></p>
        </div>
        <div class="d-flex">
            <a href="{{ url_for('dashboard.index') }}" class="btn btn-light me-2 btn-refresh" aria-label="Aktualisieren">
                <i class="fas fa-sync-alt"></i>
            </a>
            <a href="{{ url_for('projects.new_project') }}" class="btn btn-gradient">
                <i class="fas fa-plus me-1"></i> Neues Projekt
            </a>
        </div>
    </div>

<!-- Statistikkarten -->
<div class="row g-4 mb-5">
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card h-100 border-0 shadow-hover stat-card custom-stat-card" data-bs-toggle="modal" data-bs-target="#projectsModal" data-tab-target="in-progress-tab">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <i class="fas fa-hammer fa-3x text-primary"></i>
                        <span class="text-muted fw-bold fs-4">Aktuell</span>
                    </div>
                    <h3 class="mb-0">{{ in_progress|length }}</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card h-100 border-0 shadow-hover stat-card custom-stat-card" data-bs-toggle="modal" data-bs-target="#projectsModal" data-tab-target="archived-tab">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <i class="fas fa-archive fa-3x text-warning"></i>
                        <span class="text-muted fw-bold fs-4">Archiv</span>
                    </div>
                    <h3 class="mb-0">{{ archived|length }}</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card h-100 border-0 shadow-hover stat-card custom-stat-card" data-bs-toggle="modal" data-bs-target="#projectsModal" data-tab-target="all-tab">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <i class="fas fa-tasks fa-3x text-info"></i>
                        <span class="text-muted fw-bold fs-4">Gesamt</span>
                    </div>
                    <h3 class="mb-0">{{ (in_progress|length) + (completed|length) + (archived|length) }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card h-100 border-0 shadow-hover stat-card custom-stat-card" data-bs-toggle="modal" data-bs-target="#projectsModal" data-tab-target="calendar-tab">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <i class="fas fa-calendar-alt fa-3x text-success"></i>
                        <span class="text-muted fw-bold fs-4">Kalender</span>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

</div>
<!-- app/templates/dashboard/index.html -->
<!-- Modified template for Aktuelle Projekte with responsive design -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-hover aktuelle-projekte">
            <div class="card-header border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Aktuelle Projekte</h5>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#projectsModal">
                        Alle anzeigen <i class="fas fa-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                {% if in_progress %}
                <!-- Desktop and Tablet Table View -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Projektname</th>
                                <th class="d-none d-md-table-cell">Startdatum</th>
                                <th class="d-none d-lg-table-cell">Verbleibende Zeit</th>                                   
                                <th class="text-end">Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in in_progress[:5] %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="project-icon me-3">
                                                <i class="fas fa-folder" style="color: var(--accent);"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0" style="color: white;">{{ project.name }}</h6>
                                                <small class="text-muted d-block d-md-none">{{ project.start_date.strftime('%d.%m.%Y') }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell text-light">{{ project.start_date.strftime('%d.%m.%Y') }}</td>
                                    <td class="d-none d-lg-table-cell">
                                        {% if project.end_date %}
                                            <div class="progress-container">
                                                <div class="progress-wrapper">
                                                    <div class="progress" style="height: 8px; background-color: var(--primary-light);">
                                                        <div class="progress-bar" role="progressbar" 
                                                            style="width: {{ project.get_progress_percentage() }}%; background-color: var(--accent);"
                                                            aria-valuenow="{{ project.get_progress_percentage() }}" aria-valuemin="0" aria-valuemax="100">
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="date-time-container">
                                                        <span class="badge bg-info countdown-badge" style="color: #000 !important; font-weight: bold;">
                                                            {% if project.is_overdue() %}
                                                                Überfällig
                                                            {% elif project.days_remaining() == 0 %}
                                                                Heute fällig
                                                            {% elif project.days_remaining() == 1 %}
                                                                1 Tag
                                                            {% else %}
                                                                {{ project.days_remaining() }} Tage
                                                            {% endif %}
                                                        </span>
                                                        <span class="end-date date-text text-muted">{{ project.end_date.strftime('%d.%m.%Y') }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-secondary">Kein Enddatum</span>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <a href="{{ url_for('files.download_project', project_id=project.id) }}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-sm btn-outline-primary">
                                            Details
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Card View (only shown on small screens) -->
                <div class="mobile-project-cards">
                    {% for project in in_progress[:5] %}
                        <div class="project-card-mobile">
                            <div class="project-card-header">
                                <div class="project-icon me-3">
                                    <i class="fas fa-folder" style="color: var(--accent);"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0" style="color: white;">{{ project.name }}</h6>
                                </div>
                            </div>
                            <div class="project-card-body">
                                <div class="project-meta">
                                    <span class="project-date">
                                        <i class="fas fa-calendar-alt me-1"></i> {{ project.start_date.strftime('%d.%m.%Y') }}
                                    </span>
                                    {% if project.end_date %}
                                        <span class="project-date">
                                            <i class="fas fa-calendar-check me-1"></i> {{ project.end_date.strftime('%d.%m.%Y') }}
                                        </span>
                                    {% endif %}
                                </div>
                                
                                {% if project.end_date %}
                                    <div class="mobile-progress-container">
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" 
                                                style="width: {{ project.get_progress_percentage() }}%; background-color: var(--accent);"
                                                aria-valuenow="{{ project.get_progress_percentage() }}" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-center mt-1">
                                            <span class="badge bg-info mobile-countdown" style="color: #000 !important; font-weight: bold;">
                                                {% if project.is_overdue() %}
                                                    Überfällig
                                                {% elif project.days_remaining() == 0 %}
                                                    Heute fällig
                                                {% elif project.days_remaining() == 1 %}
                                                    Noch 1 Tag
                                                {% else %}
                                                    Noch {{ project.days_remaining() }} Tage
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="text-center my-2">
                                        <span class="badge bg-secondary">Kein Enddatum</span>
                                    </div>
                                {% endif %}
                                
                                <div class="project-actions">
                                    <a href="{{ url_for('files.download_project', project_id=project.id) }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                    <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-sm btn-outline-primary">
                                        Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state text-center py-5">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <h5>Keine Projekte in Bearbeitung</h5>
                    <p class="text-muted">Erstellen Sie ein neues Projekt, um loszulegen.</p>
                    <a href="{{ url_for('projects.new_project') }}" class="btn btn-primary mt-2">
                        <i class="fas fa-plus me-2"></i> Neues Projekt
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Verbessertes Projekte Modal -->
<div class="modal fade" id="projectsModal" tabindex="-1" aria-labelledby="projectsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="projectsModalLabel"><i class="fas fa-folder-open me-2 text-primary"></i>Projekte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <!-- Suche und Filter mit verbesserten Dropdown-Indikatoren -->
                <div class="mb-4">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="input-group search-group">
                                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-primary"></i></span>
                                <input type="text" class="form-control border-start-0 py-2" placeholder="Projekte suchen..." id="searchInput">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-lg py-2 select-visible-indicator" id="statusFilter">
                                <option value="all">Alle Status</option>
                                <option value="in_progress">In Bearbeitung</option>
                                <option value="completed">Kalender</option>
                                <option value="archived">Archiviert</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-lg py-2 select-visible-indicator" id="sortProjects">
                                <option value="newest">Neueste zuerst</option>
                                <option value="oldest">Älteste zuerst</option>
                                <option value="az">A-Z</option>
                                <option value="za">Z-A</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tab-navigation mb-3">
                    <select class="form-select form-select-lg d-md-none py-2" id="tabSelector">
                        <option value="all">Alle Projekte</option>
                        <option value="in-progress">In Bearbeitung</option>
                        <option value="calendar">Kalender</option>
                        <option value="archived">Archiviert</option>
                    </select>
                    <ul class="nav nav-pills nav-justified custom-nav-pills d-none d-md-flex" id="projectTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active btn-lg w-100" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" aria-controls="all" aria-selected="true">
                                <i class="fas fa-list me-1"></i> Alle
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link btn-lg w-100" id="in-progress-tab" data-bs-toggle="tab" data-bs-target="#in-progress" type="button" role="tab" aria-controls="in-progress" aria-selected="false">
                                <i class="fas fa-hammer me-1"></i> In Bearbeitung
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link btn-lg w-100" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button" role="tab" aria-controls="calendar" aria-selected="false">
                                <i class="fas fa-calendar-alt me-1"></i> Kalender
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link btn-lg w-100" id="archived-tab" data-bs-toggle="tab" data-bs-target="#archived" type="button" role="tab" aria-controls="archived" aria-selected="false">
                                <i class="fas fa-archive me-1"></i> Archiviert
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="tab-content pt-2" id="projectTabContent">
                    <!-- Alle Projekte Tab -->
                    <div class="tab-pane fade show active" id="all" role="tabpanel" aria-labelledby="all-tab">
                        {% set all_projects = in_progress + archived %}
                        {% if all_projects %}
                            <div class="row g-3 project-cards">
                                {% for project in all_projects %}
                                    <div class="col-xl-4 col-md-6 project-item" 
                                         data-status="{% if project in in_progress %}in_progress{% elif project in completed %}completed{% else %}archived{% endif %}"
                                         data-name="{{ project.name|lower }}"
                                         data-date="{{ project.start_date.strftime('%Y-%m-%d') }}">
                                        <div class="card project-card h-100 border-0 shadow-hover">
                                            <div class="card-header d-flex justify-content-between align-items-center 
                                                        {% if project in in_progress %}project-card-progress
                                                        {% elif project in completed %}project-card-completed
                                                        {% else %}project-card-archived{% endif %} border-top-0 border-start-0 border-end-0">
                                                <h6 class="mb-0 text-truncate">{{ project.name }}</h6>
                                                <span class="badge rounded-pill ms-2
                                                      {% if project in in_progress %}bg-primary-custom
                                                      {% elif project in completed %}bg-success-custom
                                                      {% else %}bg-secondary-custom{% endif %}">
                                                    {% if project in in_progress %}In Bearbeitung
                                                   
                                                    {% else %}Archiviert{% endif %}
                                                </span>
                                            </div>
                                            <div class="card-body" style="background-color:  #1d1d30;">
                                                {% if project.description %}
                                                    <p class="mb-3 project-description">{{ project.description|truncate(100) }}</p>
                                                {% else %}
                                                    <p class="text-muted mb-3"><i>Keine Beschreibung vorhanden</i></p>
                                                {% endif %}
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <!-- In der Datei, die die Dashboard-Projektliste enthält, fügen Sie diesen Code für jede Projekt-Zeile hinzu: -->
                                                    <a href="{{ url_for('files.download_project', project_id=project.id) }}" class="text-info" title="Projekt herunterladen">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                    <small class="text-muted">
                                                        <i class="far fa-calendar-alt me-1"></i> {{ project.start_date.strftime('%d.%m.%Y') }}
                                                    </small>
                                                    <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-sm 
                                                              {% if project in in_progress %}btn-project-progress
                                                              {% elif project in completed %}btn-project-completed
                                                              {% else %}btn-project-archived{% endif %}">
                                                        Details <i class="fas fa-arrow-right ms-1"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
                                    <h5>Keine Projekte vorhanden</h5>
                                    <p class="text-muted">Erstellen Sie ein neues Projekt, um loszulegen</p>
                                    <a href="{{ url_for('projects.new_project') }}" class="btn btn-gradient mt-2">
                                        <i class="fas fa-plus me-2"></i>Neues Projekt erstellen
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- In Bearbeitung Tab -->
                    <div class="tab-pane fade" id="in-progress" role="tabpanel" aria-labelledby="in-progress-tab">
                        {% if in_progress %}
                            <div class="row g-3">
                                {% for project in in_progress %}
                                    <div class="col-xl-4 col-md-6">
                                        <div class="card project-card h-100 border-0 shadow-hover">
                                            <div class="card-header d-flex justify-content-between align-items-center project-card-progress border-top-0 border-start-0 border-end-0">
                                                <h6 class="mb-0 text-truncate">{{ project.name }}</h6>
                                                <span class="badge bg-primary-custom rounded-pill ms-2">In Bearbeitung</span>
                                            </div>
                                            <div class="card-body"  style="background-color:  #1d1d30;">
                                                {% if project.description %}
                                                    <p class="mb-3 project-description">{{ project.description|truncate(100) }}</p>
                                                {% else %}
                                                    <p class="text-muted mb-3"><i>Keine Beschreibung vorhanden</i></p>
                                                {% endif %}
                                                <div class="d-flex justify-content-between align-items-center">
                                                                                                    <!-- In der Datei, die die Dashboard-Projektliste enthält, fügen Sie diesen Code für jede Projekt-Zeile hinzu: -->
                                                <a href="{{ url_for('files.download_project', project_id=project.id) }}" class="text-info" title="Projekt herunterladen">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                    <small class="text-muted">
                                                        <i class="far fa-calendar-alt me-1"></i> {{ project.start_date.strftime('%d.%m.%Y') }}
                                                    </small>
                                                    <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-sm btn-project-progress">
                                                        Details <i class="fas fa-arrow-right ms-1"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-hammer fa-4x text-primary mb-3"></i>
                                    <h5>Keine Projekte in Bearbeitung</h5>
                                    <p class="text-muted">Erstellen Sie ein neues Projekt oder aktivieren Sie ein archiviertes Projekt</p>
                                    <a href="{{ url_for('projects.new_project') }}" class="btn btn-gradient mt-2">
                                        <i class="fas fa-plus me-2"></i>Neues Projekt erstellen
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Kalender Tab -->
<div class="tab-pane fade" id="calendar" role="tabpanel" aria-labelledby="calendar-tab">
    <!-- Kalender Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="prevMonth" class="btn btn-outline-primary">< </button>
        <h4 id="currentMonthYear" class="mb-0"></h4>
        <button id="nextMonth" class="btn btn-outline-primary"> ></button>
    </div>
    
    <!-- Kalender Grid -->
    <div class="d-flex mb-2">
        <div class="calendar-weekday weekday-workday">Mo</div>
        <div class="calendar-weekday weekday-workday">Di</div>
        <div class="calendar-weekday weekday-workday">Mi</div>
        <div class="calendar-weekday weekday-workday">Do</div>
        <div class="calendar-weekday weekday-workday">Fr</div>
        <div class="calendar-weekday weekday-weekend">Sa</div>
        <div class="calendar-weekday weekday-weekend">So</div>
    </div>
    <div id="calendarDays" class="calendar-grid row gx-1 gy-1 mb-4"></div>
    
    <!-- Urlaubsliste -->
    <div>
        <h4 class="mb-3">Urlaubsübersicht</h4>
        <ul id="vacationList" class="list-group mb-2">
            <!-- Dynamische Einträge kommen hier hin -->
        </ul>       
        
    </div>
    
    <!-- Modal für neuen Urlaub -->
    <div class="modal fade" id="newVacationModal" tabindex="-1" aria-labelledby="newVacationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newVacationModalLabel">Neuen Urlaub hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
                </div>
                <div class="modal-body">
                    <form id="vacationForm">
                        <div class="mb-3">
                            <label for="vacationName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="vacationName" required>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">Startdatum</label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label">Enddatum</label>
                                <input type="date" class="form-control" id="endDate" required>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="vacationType" class="form-label">Art des Urlaubs</label>
                            <select class="form-select" id="vacationType">
                                <option value="urlaub">Urlaub</option>
                                <option value="krankheit">Krank</option>
                                <option value="sonstiges">Sonstiges</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" id="saveVacation">Speichern</button>
                </div>
            </div>
        </div>
    </div>
</div>

                    <!-- Archivierte Projekte Tab -->
                    <div class="tab-pane fade" id="archived" role="tabpanel" aria-labelledby="archived-tab">
                        {% if archived %}
                            <div class="row g-3">
                                {% for project in archived %}
                                    <div class="col-xl-4 col-md-6">
                                        <div class="card project-card h-100 border-0 shadow-hover">
                                            <div class="card-header d-flex justify-content-between align-items-center project-card-archived border-top-0 border-start-0 border-end-0">
                                                <h6 class="mb-0 text-truncate">{{ project.name }}</h6>
                                                <span class="badge bg-secondary-custom rounded-pill ms-2">Archiviert</span>
                                            </div>
                                            <div class="card-body" style="background-color:  #1d1d30;">
                                                {% if project.description %}
                                                    <p class="mb-3 project-description">{{ project.description|truncate(100) }}</p>
                                                {% else %}
                                                    <p class="text-muted mb-3"><i>Keine Beschreibung vorhanden</i></p>
                                                {% endif %}
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <!-- In der Datei, die die Dashboard-Projektliste enthält, fügen Sie diesen Code für jede Projekt-Zeile hinzu: -->
                                                <a href="{{ url_for('files.download_project', project_id=project.id) }}" class="text-info" title="Projekt herunterladen">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                    <small class="text-muted">
                                                        <i class="far fa-calendar-alt me-1"></i> {{ project.start_date.strftime('%d.%m.%Y') }}
                                                    </small>
                                                    <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-sm btn-project-archived">
                                                        Details <i class="fas fa-arrow-right ms-1"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-archive fa-4x text-secondary mb-3"></i>
                                    <h5>Keine archivierten Projekte</h5>
                                    <p class="text-muted">Archivierte Projekte werden hier angezeigt</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                <a href="{{ url_for('projects.new_project') }}" class="btn btn-gradient">
                    <i class="fas fa-plus me-1"></i> Neues Projekt
                </a>
            </div>
        </div>
    </div>
</div>
<style>
/* Responsive styling for Aktuelle Projekte */

/* Base improvements for the project table */
.table-responsive {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-radius: var(--border-radius-md);
}

/* Project card design for mobile - alternative to table */
.project-card-mobile {
    background-color: var(--primary-light);
    border: 1px solid var(--accent);
    border-radius: var(--border-radius-md);
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    display: none; /* Hidden by default */
}

/* Project header (name and icon) */
.project-card-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.project-card-body {
    padding-left: 3rem; /* Align with the icon */
}

.project-meta {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.project-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

/* Make progress bars more compact for mobile */
.mobile-progress-container {
    margin: 0.5rem 0;
}

.mobile-progress-container .progress {
    height: 6px;
    margin-bottom: 0.25rem;
}

.mobile-countdown {
    font-size: 0.85rem;
    display: inline-block;
    padding: 0.15rem 0.5rem;
}

/* Common improvements */
.aktuelle-projekte .table td {
    padding: 0.75rem; /* Slightly reduce padding */
    vertical-align: middle;
}

/* Fix table stripe colors */
.aktuelle-projekte .table tbody tr:nth-child(odd) td {
    background-color: var(--primary);
}

.aktuelle-projekte .table tbody tr:nth-child(even) td {
    background-color: var(--primary-light);
}

/* Better spacing for action buttons */
.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* Compact view for small screens */
@media (max-width: 767.98px) {
    /* Hide regular table and show card layout */
    .aktuelle-projekte .table-responsive {
        display: none;
    }
    
    .project-card-mobile {
        display: block;
    }
    
    /* Adjust header spacing */
    .aktuelle-projekte .card-header {
        padding: 0.75rem;
    }
    
    /* Smaller, more compact buttons */
    .btn-sm {
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
    }
    
    /* Make sure all icons have consistent size */
    .project-icon {
        width: 35px;
        height: 35px;
        min-width: 35px;
    }
    
    /* Improve the 'Alle anzeigen' button */
    .btn-outline-primary {
        padding: 0.3rem 0.6rem;
    }
}

/* Medium screens: show more compact table */
@media (min-width: 768px) and (max-width: 991.98px) {
    .aktuelle-projekte .table th,
    .aktuelle-projekte .table td {
        padding: 0.5rem;
    }
    
    /* More compact buttons */
    .btn-sm {
        padding: 0.25rem 0.4rem;
        font-size: 0.75rem;
    }
    
    .project-icon {
        width: 40px;
        height: 40px;
    }
}

/* Fix for scrollbar issue on some mobile browsers */
.row {
    margin-right: 0;
    margin-left: 0;
}

/* Timeline badges with better contrast and sizing */
.verbleibende-zeit-badge {
    display: inline-block;
    font-size: 0.75rem;
    padding: 0.15rem 0.5rem;
    border-radius: var(--border-radius-sm);
    font-weight: 500;
    text-align: center;
    background-color: var(--accent);
    color: var(--primary);
}

/* Small utility classes */
.project-date {
    color: var(--text-muted);
    font-size: 0.8rem;
}

.remaining-time {
    color: var(--accent);
    font-weight: 500;
}

/* Fix for project listings table pagination */
.pagination {
    justify-content: center;
    margin-top: 1rem;
}

.page-link {
    background-color: var(--primary-light);
    border-color: var(--accent);
    color: var(--accent);
}

.page-link:hover {
    background-color: var(--accent);
    color: var(--primary);
}

.page-item.active .page-link {
    background-color: var(--accent);
    border-color: var(--accent);
    color: var(--primary);
}
</style>
<script>
// JavaScript to enhance project table responsiveness
document.addEventListener('DOMContentLoaded', function() {
    // Check screen size and apply appropriate view
    function checkScreenSize() {
        const isMobile = window.innerWidth < 768;
        const tableContainer = document.querySelector('.aktuelle-projekte .table-responsive');
        const cardContainer = document.querySelector('.aktuelle-projekte .mobile-project-cards');
        
        if (tableContainer && cardContainer) {
            if (isMobile) {
                tableContainer.style.display = 'none';
                cardContainer.style.display = 'block';
            } else {
                tableContainer.style.display = 'block';
                cardContainer.style.display = 'none';
            }
        }
    }
    
    // Run on page load and window resize
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);

    // Function to update countdown timers
    function updateCountdownTimers() {
        const countdownElements = document.querySelectorAll('[id^="countdown-timer"]');
        
        countdownElements.forEach(element => {
            const projectId = element.id.split('-').pop();
            const endDateString = element.getAttribute('data-end-date');
            
            if (endDateString) {
                const endDate = new Date(endDateString);
                const now = new Date();
                
                // Calculate days remaining
                const diffTime = endDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Update the element text
                if (diffTime < 0) {
                    element.textContent = 'Überfällig';
                    element.classList.remove('bg-info', 'bg-warning', 'bg-success');
                    element.classList.add('bg-danger');
                } else if (diffDays === 0) {
                    element.textContent = 'Heute fällig';
                    element.classList.remove('bg-info', 'bg-success', 'bg-danger');
                    element.classList.add('bg-warning');
                } else if (diffDays === 1) {
                    element.textContent = '1 Tag';
                    element.classList.remove('bg-success', 'bg-danger');
                    element.classList.add('bg-warning');
                } else if (diffDays <= 3) {
                    element.textContent = diffDays + ' Tage';
                    element.classList.remove('bg-success', 'bg-danger');
                    element.classList.add('bg-warning');
                } else {
                    element.textContent = diffDays + ' Tage';
                    element.classList.remove('bg-danger', 'bg-warning');
                    element.classList.add('bg-info');
                }
            }
        });
    }
    
    // Update countdown timers on page load
    updateCountdownTimers();
    
    // Update countdown timers every minute
    setInterval(updateCountdownTimers, 60000);
    
    // Enhanced table row hover effects
    const projectRows = document.querySelectorAll('.table tbody tr');
    projectRows.forEach(row => {
        row.addEventListener('mouseenter', () => {
            row.style.backgroundColor = 'rgba(102, 252, 241, 0.1)';
        });
        
        row.addEventListener('mouseleave', () => {
            row.style.backgroundColor = '';
        });
    });
    
    // Make project cards clickable to view details
    const projectCards = document.querySelectorAll('.project-card-mobile');
    projectCards.forEach(card => {
        const detailsLink = card.querySelector('a[href*="view_project"]');
        if (detailsLink) {
            const href = detailsLink.getAttribute('href');
            card.addEventListener('click', (e) => {
                // Don't navigate if clicking on a button or link
                if (!e.target.closest('a') && !e.target.closest('button')) {
                    window.location.href = href;
                }
            });
            
            // Add visual cue that card is clickable
            card.style.cursor = 'pointer';
        }
    });
});

    // Script für Kalenderfunktionen 
document.addEventListener('DOMContentLoaded', function() {
    // Kalenderinitalisierung
    const calendarDays = document.getElementById('calendarDays');
    const currentMonthYearEl = document.getElementById('currentMonthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    
    // Projektmodal und Tab-Steuerung
    const projectsModal = document.getElementById('projectsModal');
    const statCards = document.querySelectorAll('.stat-card');
    const tabSelector = document.getElementById('tabSelector');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const sortSelect = document.getElementById('sortProjects');
    const projectItems = document.querySelectorAll('.project-item');

    // Aktuelles Datum festlegen
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    // Urlaubsdaten und Feiertage
    let vacations = [];
    
    // Feiertage für Berlin (Deutschland)

const holidays = [
    { name: 'Neujahr', date: new Date(currentYear, 0, 1) }, // 1. Januar
    { name: 'Internationaler Frauentag', date: new Date(currentYear, 2, 8) }, // 8. März
    { name: 'Karfreitag', date: getEasterRelatedDate(currentYear, -2) }, // Freitag vor Ostersonntag
    { name: 'Ostersonntag', date: getEasterRelatedDate(currentYear, 0) }, // Ostersonntag (nicht gesetzlicher Feiertag überall, in Berlin kein gesetzlicher Feiertag)
    { name: 'Ostermontag', date: getEasterRelatedDate(currentYear, 1) }, // Montag nach Ostersonntag
    { name: 'Tag der Arbeit', date: new Date(currentYear, 4, 1) }, // 1. Mai
    { name: 'Christi Himmelfahrt', date: getEasterRelatedDate(currentYear, 39) }, // 39 Tage nach Ostersonntag
    { name: 'Pfingstsonntag', date: getEasterRelatedDate(currentYear, 49) }, // Pfingstsonntag (nicht gesetzlicher Feiertag überall, in Berlin auch nicht offiziell frei)
    { name: 'Pfingstmontag', date: getEasterRelatedDate(currentYear, 50) }, // 50 Tage nach Ostersonntag
    { name: 'Tag der Deutschen Einheit', date: new Date(currentYear, 9, 3) }, // 3. Oktober
    { name: 'Reformationstag', date: new Date(currentYear, 9, 31) }, // 31. Oktober (seit 2018 in Berlin gesetzlicher Feiertag)
    { name: '1. Weihnachtstag', date: new Date(currentYear, 11, 25) }, // 25. Dezember
    { name: '2. Weihnachtstag', date: new Date(currentYear, 11, 26) } // 26. Dezember
];

// Funktion, um bewegliche Feiertage zu berechnen (basierend auf Ostersonntag)
function getEasterRelatedDate(year, offsetDays) {
    const easter = calculateEaster(year);
    const date = new Date(easter);
    date.setDate(date.getDate() + offsetDays);
    return date;
}

// Funktion zur Berechnung des Ostersonntags (nach Gauß'scher Formel)
function calculateEaster(year) {
    const f = Math.floor,
        G = year % 19,
        C = f(year / 100),
        H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30,
        I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)),
        J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7,
        L = I - J,
        month = 3 + f((L + 40) / 44),
        day = L + 28 - 31 * f(month / 4);
    return new Date(year, month - 1, day);
}


    // Local Storage Key für Urlaubsdaten
    const VACATIONS_STORAGE_KEY = 'vacation_data';

    // Lade Urlaubsdaten aus localStorage
    function loadLocalVacations() {
        const savedVacations = localStorage.getItem(VACATIONS_STORAGE_KEY);
        if (savedVacations) {
            try {
                // Parse gespeicherte Daten und konvertiere Strings zu Date-Objekten
                const parsedVacations = JSON.parse(savedVacations);
                return parsedVacations.map(vacation => ({
                    ...vacation,
                    start: new Date(vacation.start),
                    end: new Date(vacation.end)
                }));
            } catch (e) {
                console.error('Fehler beim Laden der gespeicherten Urlaubsdaten:', e);
                return [];
            }
        }
        return [];
    }

    // Speichere Urlaubsdaten im localStorage
    function saveLocalVacations() {
        try {
            localStorage.setItem(VACATIONS_STORAGE_KEY, JSON.stringify(vacations));
        } catch (e) {
            console.error('Fehler beim Speichern der Urlaubsdaten:', e);
        }
    }

    // Beim Laden der Seite Urlaubsdaten abrufen
    async function loadVacations() {
        try {
            // Versuche zuerst, Daten von der API zu laden
            const response = await fetch('/api/vacations');
            if (response.ok) {
                const data = await response.json();
                // Konvertiere Datumsstrings zu Date-Objekten
                vacations = data.map(vacation => ({
                    ...vacation,
                    start: new Date(vacation.start),
                    end: new Date(vacation.end)
                }));
            } else {
                // Wenn API-Aufruf fehlschlägt, lade aus localStorage
                console.warn('API-Aufruf fehlgeschlagen, verwende lokale Daten');
                vacations = loadLocalVacations();
            }
        } catch (error) {
            console.error('Fehler beim Laden der Urlaubsdaten:', error);
            // Bei Fehler lokale Daten laden
            vacations = loadLocalVacations();
        }
        
        // Kalender und Liste aktualisieren
        renderCalendar();
        updateVacationList();
    }

    // Lade Urlaubsdaten beim Start
    if (calendarDays) {
        loadVacations();
    }

    // Event Listener für Monatswechsel
    if (prevMonthBtn && nextMonthBtn) {
        prevMonthBtn.addEventListener('click', function() {
            if (currentMonth === 0) {
                currentMonth = 11;
                currentYear--;
            } else {
                currentMonth--;
            }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', function() {
            if (currentMonth === 11) {
                currentMonth = 0;
                currentYear++;
            } else {
                currentMonth++;
            }
            renderCalendar();
        });
    }

    // Speichern eines neuen Urlaubs
    const saveVacationBtn = document.getElementById('saveVacation');
    if (saveVacationBtn) {
        saveVacationBtn.addEventListener('click', async function() {
            const nameInput = document.getElementById('vacationName');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const typeInput = document.getElementById('vacationType');
            
            if (!nameInput || !startDateInput || !endDateInput || !typeInput) {
                console.error('Urlaubsformular-Elemente nicht gefunden');
                return;
            }
            
            const name = nameInput.value;
            const startDateStr = startDateInput.value;
            const endDateStr = endDateInput.value;
            const type = typeInput.value;

            if (!name || !startDateStr || !endDateStr) {
                alert('Bitte alle Pflichtfelder ausfüllen!');
                return;
            }

            try {
                // Versuche, den Urlaub über die API zu speichern
                const response = await fetch('/api/vacations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name, 
                        start_date: startDateStr, 
                        end_date: endDateStr, 
                        type 
                    }),
                });

                if (response.ok) {
                    await loadVacations(); // Aktualisiere die Anzeige
                } else {
                    // Wenn API-Aufruf fehlschlägt, speichere lokal
                    console.warn('API-Speicherung fehlgeschlagen, speichere lokal');
                    addLocalVacation(name, startDateStr, endDateStr, type);
                }
            } catch (error) {
                console.error('Fehler beim Speichern des Urlaubs:', error);
                // Fallback: Lokal speichern
                addLocalVacation(name, startDateStr, endDateStr, type);
            }

            // Modal schließen und Formular zurücksetzen
            const newVacationModal = bootstrap.Modal.getInstance(document.getElementById('newVacationModal'));
            if (newVacationModal) {
                newVacationModal.hide();
            }
            
            const vacationForm = document.getElementById('vacationForm');
            if (vacationForm) {
                vacationForm.reset();
            }
        });
    }

    // Funktion zum lokalen Hinzufügen eines Urlaubs
    function addLocalVacation(name, startDateStr, endDateStr, type) {
        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        
        // Neuen Urlaub zum Array hinzufügen
        vacations.push({
            id: Date.now(), // Verwende Timestamp als eindeutige ID
            name: name,
            start: startDate,
            end: endDate,
            type: type
        });

        // Speichere im localStorage
        saveLocalVacations();

        // Kalender neu rendern
        renderCalendar();

        // Liste der Urlaube aktualisieren
        updateVacationList();
    }
// Aktuallisieren liste
    function updateVacationList() {
    const vacationList = document.getElementById('vacationList');
    if (!vacationList) return;
    vacationList.innerHTML = '';

    if (vacations.length === 0) {
        const emptyItem = document.createElement('li');
        emptyItem.className = 'list-group-item fw-bold text-center text-dark';
        emptyItem.textContent = 'Keine Urlaube eingetragen';
        vacationList.appendChild(emptyItem);
        return;
    }

    vacations.forEach((vacation, index) => {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

        // Farbliche Markierung je nach Urlaubstyp hinzufügen
        const typeColorClass = getVacationTypeClass(vacation.type);
        listItem.classList.add(typeColorClass);

        const infoDiv = document.createElement('div');
        const nameEl = document.createElement('h6');
        nameEl.className = 'mb-0 fw-bold text-white'; // Schwarz und bold für den Namen
        nameEl.textContent = vacation.name;

        // Zeige den Urlaubstyp an
        const typeEl = document.createElement('span');
        typeEl.className = `badge me-2`;
        typeEl.style.backgroundColor = getVacationTypeColor(vacation.type);
        typeEl.textContent = getVacationTypeName(vacation.type);

        // Wrapper für Name und Badge
        const headerDiv = document.createElement('div');
        headerDiv.className = 'd-flex align-items-center mb-1';
        headerDiv.appendChild(typeEl);
        headerDiv.appendChild(nameEl);

        const dateEl = document.createElement('small');
        dateEl.className = 'fw-bold text-white d-block mt-1';
        const startDate = vacation.start instanceof Date ? vacation.start : new Date(vacation.start);
        const endDate = vacation.end instanceof Date ? vacation.end : new Date(vacation.end);
        dateEl.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;

        infoDiv.appendChild(headerDiv);
        infoDiv.appendChild(dateEl);

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'vacation-actions';
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-icon btn-sm text-danger';
        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        deleteBtn.addEventListener('click', async function () {
            if (confirm('Urlaub wirklich löschen?')) {
                try {
                    // Versuche erst, über die API zu löschen
                    const vacationId = vacation.id || index;
                    const response = await fetch(`/api/vacations/${vacationId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        await loadVacations();
                    } else {
                        // Fallback: Lokal löschen
                        vacations.splice(index, 1);
                        saveLocalVacations(); // Speichere die Änderung
                        updateVacationList();
                        renderCalendar();
                    }
                } catch (error) {
                    console.error('Fehler beim Löschen des Urlaubs:', error);
                    // Fallback: Lokal löschen
                    vacations.splice(index, 1);
                    saveLocalVacations(); // Speichere die Änderung
                    updateVacationList();
                    renderCalendar();
                }
            }
        });
        actionsDiv.appendChild(deleteBtn);

        listItem.appendChild(infoDiv);
        listItem.appendChild(actionsDiv);
        vacationList.appendChild(listItem);
    });
}
// Hilfsfunktion, um die CSS-Klasse für den Urlaubstyp zu bestimmen
function getVacationTypeClass(type) {
    switch (type) {
        case 'urlaub':
            return 'vacation-type-urlaub';
        case 'krankheit':
            return 'vacation-type-krankheit';
        case 'sonstiges':
            return 'vacation-type-sonstiges';
        default:
            return ''; // Fallback: keine Klasse
    }
}

// Hilfsfunktion, um die Farbe für den Urlaubstyp zu bestimmen
function getVacationTypeColor(type) {
    switch (type) {
        case 'urlaub':
            return '#58a763'; // Grün
        case 'krankheit':
            return '#dc3545'; // Rot
        case 'sonstiges':
            return '#0d6efd'; // Blau
        default:
            return '#6c757d'; // Grau als Fallback
    }
}
// Hilfsfunktion, um den angezeigten Namen für den Urlaubstyp zu bestimmen
function getVacationTypeName(type) {
    switch(type) {
        case 'urlaub':
            return 'Urlaub';
        case 'krankheit':
            return 'Krank';
        case 'sonstiges':
            return 'Sonstiges';
        default:
            return 'Abwesenheit';
    }
}

    // Formatiert ein Datum im deutschen Format
    function formatDate(date) {
        if (!(date instanceof Date) || isNaN(date)) {
            console.error('Ungültiges Datum:', date);
            return 'Ungültiges Datum';
        }
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    // Hilfsfunktion für Datumsformatierung in Input-Felder
    function formatDateForInput(date) {
        if (!(date instanceof Date) || isNaN(date)) {
            console.error('Ungültiges Datum für Input:', date);
            return '';
        }
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Rendert den Kalender
    function renderCalendar() {
        if (!calendarDays || !currentMonthYearEl) return;

        const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 
                           'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
        currentMonthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;

        // Kalender leeren
        calendarDays.innerHTML = '';

        // Ersten Tag des Monats bestimmen
        const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
        let startingDayOfWeek = firstDayOfMonth.getDay(); // 0 = Sonntag, 1 = Montag,...
        // Anpassen für Montag als ersten Tag der Woche
        if (startingDayOfWeek === 0) startingDayOfWeek = 7;
        startingDayOfWeek--; // 0 = Montag, 1 = Dienstag,...

        // Letzten Tag des Monats bestimmen
        const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDayOfMonth.getDate();

        // Tage des vorherigen Monats anzeigen
        const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
        for (let i = 0; i < startingDayOfWeek; i++) {
            const dayEl = createDayElement(prevMonthDays - startingDayOfWeek + i + 1, 'other-month');
            calendarDays.appendChild(dayEl);
        }

        // Tage des aktuellen Monats anzeigen
        const today = new Date();
        for (let i = 1; i <= daysInMonth; i++) {
            const isToday = today.getDate() === i && 
                            today.getMonth() === currentMonth && 
                            today.getFullYear() === currentYear;
            const dayEl = createDayElement(i, 'current-month' + (isToday ? ' today' : ''));

            // Prüfen, ob an diesem Tag ein Urlaub ist
            const currentDateObj = new Date(currentYear, currentMonth, i);
            const hasVacation = checkForVacation(currentDateObj);
            const hasHoliday = checkForHoliday(currentDateObj);

            if (hasVacation) {
                dayEl.classList.add('has-vacation');
                // Tooltips für Urlaub
                dayEl.setAttribute('data-bs-toggle', 'tooltip');
                dayEl.setAttribute('data-bs-html', 'true');

                // Erhalte alle Urlaubspersonen für diesen Tag
                const vacationPersons = getVacationPersons(currentDateObj);
                dayEl.setAttribute('data-bs-title', vacationPersons.join('<br>'));
            }

            if (hasHoliday) {
                dayEl.classList.add('has-holiday');
                // Tooltips für Feiertage
                const holiday = holidays.find(h => h.date.getDate() === i && 
                                    h.date.getMonth() === currentMonth &&
                                    h.date.getFullYear() === currentYear);
                if (holiday) {
                    dayEl.setAttribute('data-bs-toggle', 'tooltip');
                    dayEl.setAttribute('data-bs-title', holiday.name);
                }
            }

            calendarDays.appendChild(dayEl);
        }

        // Tage des nächsten Monats anzeigen
        const totalDaysShown = startingDayOfWeek + daysInMonth;
        const nextMonthDays = 42 - totalDaysShown; // 6 Reihen x 7 Tage = 42
        for (let i = 1; i <= nextMonthDays; i++) {
            const dayEl = createDayElement(i, 'other-month');
            calendarDays.appendChild(dayEl);
        }

        // Tooltips initialisieren
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    // Helfer-Funktion zum Erstellen von Tageselementen
    function createDayElement(day, className) {
        const dayEl = document.createElement('div');
        dayEl.className = `calendar-day col ${className}`;
        dayEl.textContent = day;

        // Klick-Event für den Tag
        dayEl.addEventListener('click', function() {
            showDayDetails(day, className);
        });

        return dayEl;
    }

    // Prüft, ob an einem bestimmten Tag ein Urlaub ist
    function checkForVacation(date) {
        return vacations.some(vacation => {
            const start = vacation.start instanceof Date ? vacation.start : new Date(vacation.start);
            const end = vacation.end instanceof Date ? vacation.end : new Date(vacation.end);
            
            // Setze Zeiten auf 00:00:00 für korrekten Vergleich
            const checkDate = new Date(date);
            checkDate.setHours(0, 0, 0, 0);
            
            const checkStart = new Date(start);
            checkStart.setHours(0, 0, 0, 0);
            
            const checkEnd = new Date(end);
            checkEnd.setHours(0, 0, 0, 0);
            
            return checkDate >= checkStart && checkDate <= checkEnd;
        });
    }

    // Prüft, ob ein bestimmter Tag ein Feiertag ist
    function checkForHoliday(date) {
        return holidays.some(holiday => {
            return date.getDate() === holiday.date.getDate() &&
                   date.getMonth() === holiday.date.getMonth() &&
                   date.getFullYear() === holiday.date.getFullYear();
        });
    }

    // Gibt alle Personen zurück, die an einem bestimmten Tag im Urlaub sind
    function getVacationPersons(date) {
        const personsOnVacation = [];
        vacations.forEach(vacation => {
            const start = vacation.start instanceof Date ? vacation.start : new Date(vacation.start);
            const end = vacation.end instanceof Date ? vacation.end : new Date(vacation.end);
            
            // Setze Zeiten auf 00:00:00 für korrekten Vergleich
            const checkDate = new Date(date);
            checkDate.setHours(0, 0, 0, 0);
            
            const checkStart = new Date(start);
            checkStart.setHours(0, 0, 0, 0);
            
            const checkEnd = new Date(end);
            checkEnd.setHours(0, 0, 0, 0);
            
            if (checkDate >= checkStart && checkDate <= checkEnd) {
                personsOnVacation.push(vacation.name);
            }
        });
        return personsOnVacation;
    }

    // Zeigt Details zu einem bestimmten Tag an
function showDayDetails(day, className) {
    if (className.includes('other-month')) return;
    const selectedDate = new Date(currentYear, currentMonth, day);

    // Immer das Modal öffnen, unabhängig von bestehenden Urlauben
    const newVacationModalElement = document.getElementById('newVacationModal');
    if (newVacationModalElement) {
        // Datum im Modal vorausfüllen
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        if (startDateInput && endDateInput) {
            startDateInput.value = formatDateForInput(selectedDate);
            endDateInput.value = formatDateForInput(selectedDate);
        }
        
        // Sicherstellen, dass das Modal-Objekt korrekt erstellt wird
        const newVacationModal = new bootstrap.Modal(newVacationModalElement);
        newVacationModal.show();
    } else {
        console.error('Modal-Element nicht gefunden');
    }
}

    // Projektmodal-Funktionalitäten
    if (projectsModal) {
        projectsModal.addEventListener('show.bs.modal', function(event) {
            // Button, der das Modal ausgelöst hat
            const button = event.relatedTarget;
            
            // Tabziel aus dem data-tab-target-Attribut extrahieren
            const tabTarget = button && button.getAttribute('data-tab-target');
            
            if (tabTarget) {
                // Entsprechenden Tab aktivieren
                const tab = document.getElementById(tabTarget);
                if (tab) {
                    // Bootstrap Tab-Objekt erstellen und aktivieren
                    const bsTab = new bootstrap.Tab(tab);
                    bsTab.show();
                    
                    // Dropdown für mobile Ansicht aktualisieren
                    if (tabSelector) {
                        tabSelector.value = tabTarget.replace('-tab', '');
                    }
                }
            }
        });

        // Animation für Modal hinzufügen
        projectsModal.addEventListener('shown.bs.modal', function() {
            const projectItems = document.querySelectorAll('.project-item');
            projectItems.forEach((item, index) => {
                setTimeout(() => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                }, 100 * index);
            });
        });
    }
    
    // Hover-Animation für Statistikkarten
    statCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            const iconWrapper = this.querySelector('.stat-icon-wrapper');
            if (iconWrapper) {
                iconWrapper.style.animation = 'pulse 1s infinite';
            }
        });
        
        card.addEventListener('mouseleave', function() {
            const iconWrapper = this.querySelector('.stat-icon-wrapper');
            if (iconWrapper) {
                iconWrapper.style.animation = '';
            }
        });
    });
    
    // Mobile Tab-Selector
    if (tabSelector) {
        tabSelector.addEventListener('change', function() {
            const selectedValue = this.value;
            const tabId = selectedValue + '-tab';
            const tab = document.getElementById(tabId);
            
            if (tab) {
                const bsTab = new bootstrap.Tab(tab);
                bsTab.show();
            }
        });
    }
    
    // Event-Listener für Tab-Wechsel zur Synchronisierung des Dropdown-Selectors
    const tabElements = document.querySelectorAll('button[data-bs-toggle="tab"]');
    tabElements.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const tabId = event.target.id;
            const tabValue = tabId.replace('-tab', '');
            
            if (tabSelector) {
                tabSelector.value = tabValue;
            }
        });
    });
    
    // Filter- und Suchfunktion für Projekte
    function filterProjects() {
        if (!searchInput || !statusFilter || !projectItems.length) return;
        
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        let visibleCount = 0;
        
        projectItems.forEach(item => {
            const projectName = item.getAttribute('data-name').toLowerCase();
            const projectStatus = item.getAttribute('data-status');
            
            const matchesSearch = projectName.includes(searchTerm);
            const matchesStatus = statusValue === 'all' || projectStatus === statusValue;
            
            if (matchesSearch && matchesStatus) {
                item.style.display = '';
                visibleCount++;
                
                // Animation beim Anzeigen hinzufügen
                item.style.animation = 'fadeIn 0.3s ease forwards';
            } else {
                item.style.display = 'none';
            }
        });
        
        // Wenn keine Ergebnisse gefunden wurden, zeige eine Nachricht an
        const noResultsMsg = document.getElementById('noResultsMessage');
        const projectContainer = document.querySelector('.project-cards');
        
        if (visibleCount === 0 && projectContainer) {
            if (!noResultsMsg) {
                const msgDiv = document.createElement('div');
                msgDiv.id = 'noResultsMessage';
                msgDiv.className = 'text-center py-4 mt-3';
                msgDiv.innerHTML = `
                    <i class="fas fa-search fa-2x text-muted mb-3"></i>
                    <h5>Keine Projekte gefunden</h5>
                    <p class="text-muted">Versuchen Sie es mit anderen Suchbegriffen oder Filtern</p>
                `;
                
                projectContainer.appendChild(msgDiv);
            }
        } else if (noResultsMsg) {
            noResultsMsg.remove();
        }
    }
    
    // Sortierung von Projekten
    function sortProjects() {
        if (!sortSelect || !projectItems.length) return;
        
        const sortValue = sortSelect.value;
        const projectContainer = document.querySelector('.project-cards');
        if (!projectContainer) return;
        
        const projectsArray = Array.from(projectItems);
        
        projectsArray.sort((a, b) => {
            const aName = a.getAttribute('data-name').toLowerCase();
            const bName = b.getAttribute('data-name').toLowerCase();
            const aDate = a.getAttribute('data-date');
            const bDate = b.getAttribute('data-date');
            
            if (sortValue === 'az') {
                return aName.localeCompare(bName);
            } else if (sortValue === 'za') {
                return bName.localeCompare(aName);
            } else if (sortValue === 'newest') {
                return bDate.localeCompare(aDate);
            } else if (sortValue === 'oldest') {
                return aDate.localeCompare(bDate);
            }
            return 0;
        });
        
        projectsArray.forEach(project => {
            projectContainer.appendChild(project);
        });
    }
    
    // Event-Listener für Suchfunktionen
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(filterProjects, 300);
        });
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', filterProjects);
    }
    
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            sortProjects();
            filterProjects();
        });
    }
    
    // Direkter Aufruf des Modals mit URL-Parameter
    function checkForModalParameter() {
        const urlParams = new URLSearchParams(window.location.search);
        const modalParam = urlParams.get('modal');
        const tabParam = urlParams.get('tab');
        
        if (modalParam === 'projects' && projectsModal) {
            const modal = new bootstrap.Modal(projectsModal);
            modal.show();
            
            if (tabParam) {
                const tabId = tabParam + '-tab';
                const tabElement = document.getElementById(tabId);
                
                if (tabElement) {
                    const tab = new bootstrap.Tab(tabElement);
                    tab.show();
                    
                    // Dropdown für mobile Ansicht aktualisieren
                    if (tabSelector) {
                        tabSelector.value = tabParam;
                    }
                }
            }
        }
    }
    
    // Prüfen, ob das Modal angezeigt werden soll
    checkForModalParameter();
    
    // Touch-optimierte Interaktionen für mobile Geräte
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.addEventListener('touchstart', function() {
            this.classList.add('nav-link-touch');
        });
        
        link.addEventListener('touchend', function() {
            this.classList.remove('nav-link-touch');
        });
    });
    
    // Verbessertes visuelles Feedback beim Hover für alle interaktiven Elemente
    const hoverCards = document.querySelectorAll('.hover-card, .project-card');
    hoverCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transition = 'all 0.3s ease';
        });
    });
    
    // Initialer Kalender-Render, wenn die Elemente existieren
    if (calendarDays) {
        renderCalendar();
    }
});

// JavaScript für die Dashboard-Seite (index.html)
document.addEventListener('DOMContentLoaded', function() {
    // 1. Fix für den Countdown-Timer "WIRD GELADEN..."
    updateAllCountdownTimers();
    // Alle 30 Sekunden aktualisieren
    setInterval(updateAllCountdownTimers, 30000);
    
    // 2. Event-Listener für die Schnellauswahl-Buttons in allen Modals
    setupQuickSelectButtons();
    
    // 3. Formular-Validierung und Übermittlung für alle End-Date-Formulare
    setupEndDateForms();
});

// Funktion zum Aktualisieren aller Countdown-Timer auf der Seite
function updateAllCountdownTimers() {
    // Alle Countdown-Timer auf der Seite finden
    const countdownTimers = document.querySelectorAll('[id^="countdown-timer"]');
    
    countdownTimers.forEach(timer => {
        // Projekt-ID aus dem Timer-Element oder dem übergeordneten Element extrahieren
        const row = timer.closest('tr');
        if (!row) return;
        
        // Projekt-ID aus der Modal-ID oder einem data-Attribut extrahieren
        const modalId = row.querySelector('[data-bs-target^="#changeEndDateModal_"]');
        if (!modalId) return;
        
        const projectId = modalId.getAttribute('data-bs-target').split('_')[1];
        
        updateTimerForProject(timer, projectId);
    });
}

// Funktion zum Aktualisieren eines einzelnen Countdown-Timers
function updateTimerForProject(timerElement, projectId) {
    if (!timerElement || !projectId) return;
    
    fetch(`/api/project/${projectId}/remaining-time`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Netzwerkantwort war nicht ok');
            }
            return response.json();
        })
        .then(data => {
            // Countdown-Badge aktualisieren
            timerElement.textContent = data.remaining_detailed;
            timerElement.className = `badge bg-${data.status}`;
            
            // Fortschrittsbalken aktualisieren, falls vorhanden
            const progressBarId = `progress-bar-${projectId}`;
            const progressBar = document.getElementById(progressBarId);
            if (progressBar) {
                progressBar.style.width = `${data.progress_percentage}%`;
                progressBar.className = `progress-bar bg-${data.status}`;
            }
        })
        .catch(error => {
            console.error('Fehler beim Abrufen der verbleibenden Zeit:', error);
            timerElement.textContent = 'Fehler';
            timerElement.className = 'badge bg-danger';
        });
}

// Funktion zum Einrichten der Schnellauswahl-Buttons für alle Modals
function setupQuickSelectButtons() {
    // Alle Schnellauswahl-Buttons finden
    const quickSelectButtons = document.querySelectorAll('.quick-select-btn');
    
    quickSelectButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Werte aus dem Button abrufen
            const value = parseInt(this.getAttribute('data-value'));
            const unit = this.getAttribute('data-unit');
            
            // Modal-ID finden, um die Projekt-ID zu extrahieren
            const modal = this.closest('.modal');
            if (!modal) return;
            
            const projectId = modal.id.split('_')[1];
            if (!projectId) return;
            
            console.log(`Quick select for project ${projectId}: +${value} ${unit}`);
            
            // Formular für die Schnellauswahl vorbereiten und absenden
            const adjustForm = document.getElementById(`adjustForm_${projectId}`);
            if (!adjustForm) return;
            
            // Versteckte Felder setzen
            let valueInput = adjustForm.querySelector('input[name="value"]');
            if (valueInput) valueInput.value = value;
            
            let unitInput = adjustForm.querySelector('input[name="unit"]');
            if (unitInput) unitInput.value = unit;
            
            // Formular absenden
            adjustForm.submit();
        });
    });
}

// Funktion zum Einrichten der Enddatum-Formulare
function setupEndDateForms() {
    // Alle Enddatum-Formulare finden
    const endDateForms = document.querySelectorAll('[id^="endDateForm_"]');
    
    endDateForms.forEach(form => {
        form.addEventListener('submit', function(event) {
            const dateInput = this.querySelector('input[name="end_date"]');
            
            if (!dateInput || !dateInput.value) {
                event.preventDefault();
                alert('Bitte ein gültiges Datum eingeben.');
                return false;
            }
            
            console.log('Submitting form with end date:', dateInput.value);
        });
    });
}    
</script>
{% endblock %}

{% block scripts %}
    {{ super() }}  <!-- This keeps any scripts from the parent template -->
    <script src="{{ url_for('static', filename='js/index_script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/projects_view.js') }}"></script>
{% endblock %}