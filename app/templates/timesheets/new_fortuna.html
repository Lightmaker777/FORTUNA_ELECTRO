<!-- app/templates/timesheets/new_fortuna.html -->
{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/new_fortuna.css') }}">
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-lg">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #14304d; color: var(--accent)">
                    <h3 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>Bau-Tagesbericht und Stundennachweis
                    </h3>
                    <span class="badge" style="background-color: #14304d; color: var(--accent)">{{ project.name }}</span>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted mb-4">Erfassen Sie Ihren Bau-Tagesbericht für das Projekt "{{ project.name }}"</p>

                    <form method="POST" action="{{ url_for('timesheets.new_timesheet', project_id=project.id) }}" id="timesheet-form">
                        {{ form.hidden_tag() }}
                        
                        <!-- Fortuna Elektro Kopfdaten -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="datum" class="form-label fw-bold">Datum:</label>
                                    {{ form.date(class="form-control" + (" is-invalid" if form.date.errors else ""), type="date", id="datum") }}
                                    {% if form.date.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bauvorhaben" class="form-label fw-bold">BV (Bauvorhaben):</label>
                                    <input type="text" class="form-control" id="bauvorhaben" name="bauvorhaben" value="{{ project.name }}" readonly>
                                </div>
                            
                                <div class="mb-3">
                                    <label for="arbeitskraft" class="form-label fw-bold">Arbeitskraft:</label>
                                    <input style="background-color: #14304d; color: var(--accent)" type="text" class="form-control" id="arbeitskraft" name="arbeitskraft" value="{{ current_user.username }}" placeholder="Name(n) der Arbeitskraft(e) eingeben">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="an_abreise" class="form-label fw-bold">An-u. Abreise:</label>
                                    <input type="text" class="form-control" id="an_abreise" name="an_abreise" placeholder="z.B. '07:45 - 17:15'">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="p-3 h-100 rounded" style="background-color: #14304d; color: var(--accent)">
                                    <div class="text-center mb-3">
                                        <img src="/static/img/logo_new1.png" alt="Fortuna Elektro GmbH" class="img-fluid" style="max-height: 50px;">
                                    </div>
                                    <div class="text-center">
                                        <p class="mb-1"><strong>Fortuna Elektro GmbH</strong></p>
                                        <p class="mb-1">Lothar-Bucher-Straße 5</p>
                                        <p class="mb-1">12157 Berlin</p>
                                        <p class="mb-1">+49 (030) 499 657 15</p>
                                        <p class="mb-0">info@fortuna-elektro.com</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Arbeitseinsatz-Tabelle -->
                        <h5 class="mb-3"><i class="far fa-clock me-2"></i>Arbeitseinsatz</h5>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered" id="arbeitseinsatz-table" style="background-color: #14304d; color: var(--accent)">
                                <thead class="table" style="background-color: #14304d; color: var(--accent)">
                                    <tr style="background-color: #14304d; color: var(--accent)">
                                        <th style="width: 40%">Tätigkeit</th>
                                        <th>Von</th>
                                        <th>Bis</th>
                                        <th>Std</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <select class="form-select activity-select" style="background-color: #14304d !important; color: var(--accent) !important;">
                                                {% for value, label in form.activity.choices %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="time" class="form-control time-from" value="00:00" style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="time" class="form-control time-to" value="00:00" style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="text" class="form-control time-hours" value="0.0" readonly style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td class="text-center" style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" style="display:none;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end fw-bold" style="background-color: #14304d; color: var(--accent)">Gesamtstunden:</td>
                                        <td style="background-color: #14304d; color: var(--accent)">
                                            {{ form.hours(class="form-control total-hours" + (" is-invalid" if form.hours.errors else ""), readonly=true) }}
                                            {% if form.hours.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in form.hours.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td style="background-color: #14304d; color: var(--accent)"></td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="text-end">
                                <button type="button" class="btn btn-sm btn-primary" id="add-row-btn">
                                    <i class="fas fa-plus me-1"></i>Zeile hinzufügen
                                </button>
                            </div>
                        </div>
                        
                        <!-- Andere Tätigkeit Box (erscheint wenn 'Andere' ausgewählt) -->
                        <div id="other-activity-div" style="display:none;" class="mb-4 animate__animated animate__fadeIn">
                            <label for="{{ form.other_activity.id }}" class="form-label fw-bold">
                                <i class="fas fa-edit me-2"></i>{{ form.other_activity.label.text }}
                            </label>
                            {{ form.other_activity(class="form-control" + (" is-invalid" if form.other_activity.errors else ""), placeholder="Bitte geben Sie Ihre Tätigkeit ein...") }}
                            {% if form.other_activity.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.other_activity.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Material-Tabelle -->
                        <h5 class="mb-3"><i class="fas fa-tools me-2"></i>Material</h5>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered" id="material-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 70%">Material</th>
                                        <th>Menge</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <select class="form-select material-name" style="background-color: #14304d !important; color: var(--accent) !important;">
                                                <option value="">Bitte auswählen</option>
                                                {% for value, label in material_choices %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="text" class="form-control material-quantity" placeholder="z.B. 25m" style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td class="text-center" style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-material-btn">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="text-end">
                                <button type="button" class="btn btn-sm btn-primary" id="add-material-btn">
                                    <i class="fas fa-plus me-1"></i>Material hinzufügen
                                </button>
                            </div>
                        </div>
                        
                        <!-- Andere Materialien Box (erscheint wenn 'Andere Materialien' ausgewählt) -->
                        <div id="other-material-div" style="display:none;" class="mb-4 animate__animated animate__fadeIn">
                            <label for="{{ form.other_material.id }}" class="form-label fw-bold">
                                <i class="fas fa-edit me-2"></i>{{ form.other_material.label.text }}
                            </label>
                            {{ form.other_material(class="form-control" + (" is-invalid" if form.other_material.errors else ""), placeholder="Bitte geben Sie das Material ein...") }}
                            {% if form.other_material.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.other_material.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Notizen mit Markdown-Hinweis -->
                        <div class="mb-4">
                            <label for="{{ form.notes.id }}" class="form-label fw-bold">
                                <i class="fas fa-sticky-note me-2"></i>{{ form.notes.label.text }}
                            </label>
                            <div class="notes-container position-relative">
                                {{ form.notes(class="form-control" + (" is-invalid" if form.notes.errors else ""), rows=4, placeholder="Zusätzliche Informationen zum Bau-Tagesbericht...") }}
                                <div class="character-counter small text-muted position-absolute bottom-0 end-0 m-2">
                                    <span id="char-count">0</span>/500
                                </div>
                            </div>
                            <div class="form-text">
                                <small>Markdown wird unterstützt. Verwenden Sie *kursiv* oder **fett** für Formatierungen.</small>
                            </div>
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Versteckte Felder für Arbeitseinsatz und Material JSON-Daten -->
                        <input type="hidden" name="arbeitseinsatz_data" id="arbeitseinsatz_data">
                        <input type="hidden" name="material_data" id="material_data" value="[]">
                        {{ form.activity(type="hidden", id="activity-hidden") }}
                        {{ form.material(type="hidden", id="material-hidden") }}
                        
                        <hr class="my-4">
                        
                        <!-- Speichern-Button mit Keyboard Shortcut -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-2"></i>Abbrechen
                            </a>
                            <button type="submit" class="btn btn-primary" id="save-btn">
                                <i class="fas fa-save me-2"></i>PDF erstellen und speichern
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer bg-light py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small text-muted">
                            <i class="fas fa-info-circle me-1"></i> Alle Felder werden für die PDF-Erstellung verwendet
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary" style="background-color: #14304d; color: var(--accent)" data-bs-toggle="modal" data-bs-target="#previewModal">
                                <i class="fas fa-eye me-1"></i>Vorschau
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vorschau Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">PDF Vorschau</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <div class="preview-content p-4">
                    <!-- Header -->
                    <div class="row mb-5">
                        <div class="col-7">
                            <div class="mb-2"><strong>Datum:</strong> <span id="preview-datum"></span></div>
                            <div class="mb-2"><strong>BV:</strong> <span id="preview-bv"></span></div>
                            <div class="mb-2"><strong>Arbeitskraft:</strong> <span id="preview-arbeitskraft"></span></div>
                            <div><strong>An-u. Abreise:</strong> <span id="preview-an-abreise"></span></div>
                        </div>
                        <div class="col-5">
                            <div class="text-end">
                                <div class="text-center mb-3">
                                    <img src="/static/img/fortuna-logo.png" alt="Fortuna Elektro GmbH" class="img-fluid" style="max-height: 50px;">
                                </div>
                                <p class="mb-1"><strong>Fortuna Elektro GmbH</strong></p>
                                <p class="mb-1">Lothar-Bucher-Straße 5</p>
                                <p class="mb-1">12157 Berlin</p>
                                <p class="mb-1">+49 (030) 499 657 15</p>
                                <p class="mb-0">info@fortuna-elektro.com</p>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="text-center mb-4">Bau-Tagesbericht und Stundennachweis</h4>
                    
                    <!-- Arbeitseinsatz -->
                    <h5 class="mb-3">Arbeitseinsatz</h5>
                    <table class="table table-bordered mb-4">
                        <thead class="table-light">
                            <tr>
                                <th>Tätigkeit</th>
                                <th>von</th>
                                <th>bis</th>
                                <th>Std</th>
                            </tr>
                        </thead>
                        <tbody id="preview-arbeitseinsatz">
                            <!-- Wird per JavaScript befüllt -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Gesamtstunden:</strong></td>
                                <td id="preview-stunden-summe"></td>
                            </tr>
                        </tfoot>
                    </table>
                   
                    <!-- Material-Tabelle modal pdf vorschau -->
                    <!-- Material -->
                    <h5 class="mb-3"><i class="fas fa-tools me-2"></i>Material</h5>
                    <table class="table table-bordered mb-4">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 70%">Material</th>
                                <th>Menge</th>
                            </tr>
                        </thead>
                        <tbody id="preview-material">
                            <!-- Wird per JavaScript befüllt -->
                        </tbody>
                    </table>
                    
                    <!-- Notizen -->
                    <div id="preview-notes-section" style="display:none;">
                        <h5 class="mb-3">Notizen</h5>
                        <div class="p-3 bg-light rounded" id="preview-notes"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
    {{ super() }}  <!-- This keeps any scripts from the parent template -->
    <script src="{{ url_for('static', filename='js/new_fortuna.js') }}"></script>
{% endblock %}