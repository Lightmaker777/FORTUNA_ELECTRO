<!-- app/templates/timesheets/new_fortuna.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-lg">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #14304d; color: var(--accent)">
                    <h3 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>Bau-Tagesbericht und Stundennachweis
                    </h3>
                    <span class="badge" style="background-color: #14304d; color: var(--accent)">{{ project.name }}</span>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted mb-4">Erfassen Sie Ihren Bau-Tagesbericht für das Projekt "{{ project.name }}"</p>

                    <form method="POST" action="{{ url_for('timesheets.new_timesheet', project_id=project.id) }}" id="timesheet-form">
                        {{ form.hidden_tag() }}
                        
                        <!-- Fortuna Elektro Kopfdaten -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="datum" class="form-label fw-bold">Datum:</label>
                                    {{ form.date(class="form-control" + (" is-invalid" if form.date.errors else ""), type="date", id="datum") }}
                                    {% if form.date.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3" >
                                    <label for="bauvorhaben" class="form-label fw-bold">BV (Bauvorhaben):</label>
                                    <input type="text" class="form-control" id="bauvorhaben" name="bauvorhaben" value="{{ project.name }}" readonly>
                                </div>
                            
                                <div class="mb-3" >
                                    <label for="arbeitskraft" class="form-label fw-bold">Arbeitskraft:</label>
                                    <input style="background-color: #14304d; color: var(--accent)"type="text" class="form-control" id="arbeitskraft" name="arbeitskraft" value="{{ current_user.username }}" placeholder="Name(n) der Arbeitskraft(e) eingeben">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="an_abreise" class="form-label fw-bold">An-u. Abreise:</label>
                                    <input type="text" class="form-control" id="an_abreise" name="an_abreise" placeholder="z.B. '07:45 - 17:15'">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="p-3 h-100 rounded" style="background-color: #14304d; color: var(--accent)">
                                    <div class="text-center mb-3">
                                        <img src="/static/img/logo_new1.png" alt="Fortuna Elektro GmbH" class="img-fluid" style="max-height: 50px;">
                                    </div>
                                    <div class="text-center">
                                        <p class="mb-1"><strong>Fortuna Elektro GmbH</strong></p>
                                        <p class="mb-1">Lothar-Bucher-Straße 5</p>
                                        <p class="mb-1">12157 Berlin</p>
                                        <p class="mb-1">+49 (030) 499 657 15</p>
                                        <p class="mb-0">info@fortuna-elektro.com</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Arbeitseinsatz-Tabelle -->
                        <h5 class="mb-3" ><i class="far fa-clock me-2"></i>Arbeitseinsatz</h5>
                        <div class="table-responsive mb-4" >
                            <table class="table table-bordered" id="arbeitseinsatz-table" style="background-color: #14304d; color: var(--accent)">
                                <thead class="table" style="background-color: #14304d; color: var(--accent)">
                                    <tr style="background-color: #14304d; color: var(--accent)">
                                        <th style="width: 40%">Tätigkeit</th>
                                        <th>Von</th>
                                        <th>Bis</th>
                                        <th>Std</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <select class="form-select activity-select" style="background-color: #14304d !important; color: var(--accent) !important;">
                                                {% for value, label in form.activity.choices %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="time" class="form-control time-from" value="00:00" style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="time" class="form-control time-to" value="00:00" style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="text" class="form-control time-hours" value="0.0" readonly style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td class="text-center" style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" style="display:none;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot >
                                    <tr >
                                        <td colspan="3" class="text-end fw-bold" style="background-color: #14304d; color: var(--accent)">Gesamtstunden:</td>
                                        <td style="background-color: #14304d; color: var(--accent)">
                                            {{ form.hours(class="form-control total-hours" + (" is-invalid" if form.hours.errors else ""), readonly=true) }}
                                            {% if form.hours.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in form.hours.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td style="background-color: #14304d; color: var(--accent)"></td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="text-end" >
                                <button type="button" class="btn btn-sm btn-primary" id="add-row-btn">
                                    <i class="fas fa-plus me-1"></i>Zeile hinzufügen
                                </button>
                            </div>
                        </div>
                        
                        <!-- Andere Tätigkeit Box (erscheint wenn 'Andere' ausgewählt) -->
                        <div id="other-activity-div" style="display:none;" class="mb-4 animate__animated animate__fadeIn">
                            <label for="{{ form.other_activity.id }}" class="form-label fw-bold">
                                <i class="fas fa-edit me-2"></i>{{ form.other_activity.label.text }}
                            </label>
                            {{ form.other_activity(class="form-control" + (" is-invalid" if form.other_activity.errors else ""), placeholder="Bitte geben Sie Ihre Tätigkeit ein...") }}
                            {% if form.other_activity.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.other_activity.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Material-Tabelle -->
                        <h5 class="mb-3"><i class="fas fa-tools me-2"></i>Material</h5>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered" id="material-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 70%">Material</th>
                                        <th>Menge</th>
                                        <th style="width: 40px "></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr >
                                        <td  style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <select class="form-select material-name">
                                                <option value="">Bitte auswählen</option>
                                                {% for value, label in material_choices %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td  style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="text" class="form-control material-quantity" placeholder="z.B. 25m ">
                                        </td>
                                        <td class="text-center"  style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-material-btn">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="text-end">
                                <button type="button" class="btn btn-sm btn-primary" id="add-material-btn">
                                    <i class="fas fa-plus me-1"></i>Material hinzufügen
                                </button>
                            </div>
                        </div>
                        <!-- Andere Materialien Box (erscheint wenn 'Andere Materialien' ausgewählt) -->
                        <div id="other-material-div" style="display:none;" class="mb-4 animate__animated animate__fadeIn">
                            <label for="{{ form.other_material.id }}" class="form-label fw-bold">
                                <i class="fas fa-edit me-2"></i>{{ form.other_material.label.text }}
                            </label>
                            {{ form.other_material(class="form-control" + (" is-invalid" if form.other_material.errors else ""), placeholder="Bitte geben Sie das Material ein...") }}
                            {% if form.other_material.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.other_material.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Notizen mit Markdown-Hinweis -->
                        <div class="mb-4">
                            <label for="{{ form.notes.id }}" class="form-label fw-bold">
                                <i class="fas fa-sticky-note me-2"></i>{{ form.notes.label.text }}
                            </label>
                            <div class="notes-container position-relative">
                                {{ form.notes(class="form-control" + (" is-invalid" if form.notes.errors else ""), rows=4, placeholder="Zusätzliche Informationen zum Bau-Tagesbericht...") }}
                                <div class="character-counter small text-muted position-absolute bottom-0 end-0 m-2">
                                    <span id="char-count">0</span>/500
                                </div>
                            </div>
                            <div class="form-text">
                                <small>Markdown wird unterstützt. Verwenden Sie *kursiv* oder **fett** für Formatierungen.</small>
                            </div>
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <!-- Versteckte Felder für Arbeitseinsatz und Material JSON-Daten -->
                        <input type="hidden" name="arbeitseinsatz_data" id="arbeitseinsatz_data">
                        <input type="hidden" name="material_data" id="material_data" value="[]">
                        {{ form.activity(type="hidden", id="activity-hidden") }}
                        {{ form.material(type="hidden", id="material-hidden") }}
                        
                        
                        <hr class="my-4">
                        
                        <!-- Speichern-Button mit Keyboard Shortcut -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-2"></i>Abbrechen
                            </a>
                            <button type="submit" class="btn btn-primary" id="save-btn">
                                <i class="fas fa-save me-2"></i>PDF erstellen und speichern
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer bg-light py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small text-muted">
                            <i class="fas fa-info-circle me-1"></i> Alle Felder werden für die PDF-Erstellung verwendet
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary" style="background-color: #14304d; color: var(--accent)"data-bs-toggle="modal" data-bs-target="#previewModal">
                                <i class="fas fa-eye me-1"></i>Vorschau
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vorschau Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">PDF Vorschau</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <div class="preview-content p-4">
                    <!-- Header -->
                    <div class="row mb-5">
                        <div class="col-7">
                            <div class="mb-2"><strong>Datum:</strong> <span id="preview-datum"></span></div>
                            <div class="mb-2"><strong>BV:</strong> <span id="preview-bv"></span></div>
                            <div class="mb-2"><strong>Arbeitskraft:</strong> <span id="preview-arbeitskraft"></span></div>
                            <div><strong>An-u. Abreise:</strong> <span id="preview-an-abreise"></span></div>
                        </div>
                        <div class="col-5">
                            <div class="text-end">
                                <div class="text-center mb-3">
                                    <img src="/static/img/fortuna-logo.png" alt="Fortuna Elektro GmbH" class="img-fluid" style="max-height: 50px;">
                                </div>
                                <p class="mb-1"><strong>Fortuna Elektro GmbH</strong></p>
                                <p class="mb-1">Lothar-Bucher-Straße 5</p>
                                <p class="mb-1">12157 Berlin</p>
                                <p class="mb-1">+49 (030) 499 657 15</p>
                                <p class="mb-0">info@fortuna-elektro.com</p>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="text-center mb-4">Bau-Tagesbericht und Stundennachweis</h4>
                    
                    <!-- Arbeitseinsatz -->
                    <h5 class="mb-3">Arbeitseinsatz</h5>
                    <table class="table table-bordered mb-4">
                        <thead class="table-light">
                            <tr>
                                <th>Tätigkeit</th>
                                <th>von</th>
                                <th>bis</th>
                                <th>Std</th>
                            </tr>
                        </thead>
                        <tbody id="preview-arbeitseinsatz">
                            <!-- Wird per JavaScript befüllt -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Gesamtstunden:</strong></td>
                                <td id="preview-stunden-summe"></td>
                            </tr>
                        </tfoot>
                    </table>
                   
                    <!-- Material-Tabelle modal pdf vorschau -->
<!-- Material -->
<h5 class="mb-3"><i class="fas fa-tools me-2"></i>Material</h5>
<table class="table table-bordered mb-4">
    <thead class="table-light">
        <tr>
            <th style="width: 70%">Material</th>
            <th>Menge</th>
        </tr>
    </thead>
    <tbody id="preview-material">
        <!-- Wird per JavaScript befüllt -->
    </tbody>
</table>
                    
                    <!-- Notizen -->
                    <div id="preview-notes-section" style="display:none;">
                        <h5 class="mb-3">Notizen</h5>
                        <div class="p-3 bg-light rounded" id="preview-notes"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<style>
#arbeitskraft.form-control {
  background-color: #14304d !important;
  color: var(--accent) !important;
  
}
.dark-input.form-control,
input.dark-input.form-control,
select.dark-input.form-select,
.dark-input .form-select,
.dark-input .form-control,
#arbeitseinsatz-tabelle input,
#arbeitseinsatz-tabelle select,
#arbeitseinsatz-tabelle td {
    background-color: #14304d !important;
    color: var(--accent) !important;
    border-color: #2c5682 !important;
  
}
/* Einfache Lösung für bessere Sichtbarkeit */

/* Dropdown-Pfeile weiß machen */
.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e") !important;
}

/* Zeit-Auswahlpfeile weiß machen */
input[type="time"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
}

/* Optional: Hellerer Hintergrund für besseren Kontrast */
.form-select, input.form-control {
    background-color: #1a3d5c !important;
}
/* Datumsauswahl-Icon weiß machen */
input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1); /* Macht das Kalendersymbol weiß */
    opacity: 0.8; /* Etwas transparenter für bessere Sichtbarkeit */
}

</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hilfsfunktion zur Zeitberechnung
    function calculateHours(timeFrom, timeTo) {
        if (!timeFrom || !timeTo) return 0;
        
        const [fromHours, fromMinutes] = timeFrom.split(':').map(Number);
        const [toHours, toMinutes] = timeTo.split(':').map(Number);
        
        let hours = toHours - fromHours;
        let minutes = toMinutes - fromMinutes;
        
        if (minutes < 0) {
            hours--;
            minutes += 60;
        }
        
        return hours + (minutes / 60);
    }
    
    // Funktionen für die Arbeitseinsatz-Tabelle
    function updateAllHours() {
        let totalHours = 0;
        
        document.querySelectorAll('#arbeitseinsatz-table tbody tr').forEach(row => {
            const timeFrom = row.querySelector('.time-from').value;
            const timeTo = row.querySelector('.time-to').value;
            const hours = calculateHours(timeFrom, timeTo);
            
            row.querySelector('.time-hours').value = hours.toFixed(1);
            totalHours += hours;
        });
        
        document.querySelector('.total-hours').value = totalHours.toFixed(1);
        updateJsonData();
    }
    
    function addTimeRow() {
        const tbody = document.querySelector('#arbeitseinsatz-table tbody');
        const newRow = document.createElement('tr');
        
        // Klone die Options aus dem ursprünglichen Select
        const originalSelect = document.querySelector('.activity-select');
        const optionsHTML = Array.from(originalSelect.options)
            .map(opt => `<option value="${opt.value}">${opt.text}</option>`)
            .join('');
        
        newRow.innerHTML = `
            <td>
                <select class="form-select activity-select">
                    ${optionsHTML}
                </select>
            </td>
            <td>
                <input type="time" class="form-control time-from" value="00:00">
            </td>
            <td>
                <input type="time" class="form-control time-to" value="00:00">
            </td>
            <td>
                <input type="text" class="form-control time-hours" value="0.0" readonly>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(newRow);
        
        // Event-Listener hinzufügen
        const timeFromInput = newRow.querySelector('.time-from');
        const timeToInput = newRow.querySelector('.time-to');
        const activitySelect = newRow.querySelector('.activity-select');
        const removeBtn = newRow.querySelector('.remove-row-btn');
        
        timeFromInput.addEventListener('change', updateAllHours);
        timeToInput.addEventListener('change', updateAllHours);
        activitySelect.addEventListener('change', checkForOtherActivity);
        removeBtn.addEventListener('click', function() {
            tbody.removeChild(newRow);
            updateAllHours();
            updateRemoveButtons();
        });
        
        updateAllHours();
        updateRemoveButtons();
    }
    
    function updateRemoveButtons() {
        const rows = document.querySelectorAll('#arbeitseinsatz-table tbody tr');
        rows.forEach((row, index) => {
            const btn = row.querySelector('.remove-row-btn');
            if (rows.length > 1) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        });
    }
    
    
    // Funktionen für die Material-Tabelle
// Funktionen für die Material-Tabelle
function addMaterialRow() {
    const tbody = document.querySelector('#material-table tbody');
    const newRow = document.createElement('tr');
    
    newRow.innerHTML = `
        <td>
            <select class="form-select material-name">
                <option value="">Bitte auswählen</option>
                {% for value, label in material_choices %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="text" class="form-control material-quantity" placeholder="z.B. 25m">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-material-btn">
                <i class="fas fa-times"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(newRow);
    
    // Event-Listener hinzufügen
    const removeBtn = newRow.querySelector('.remove-material-btn');
    removeBtn.addEventListener('click', function() {
        // Prüfen, ob es die letzte Zeile ist
        if (tbody.children.length > 1) {
            tbody.removeChild(newRow);
        } else {
            // Bei der letzten Zeile nur die Felder leeren
            newRow.querySelector('.material-name').value = "";
            newRow.querySelector('.material-quantity').value = "";
        }
        updateMaterialRemoveButtons();
        updateJsonData();
    });
    
    const materialInputs = newRow.querySelectorAll('input');
    materialInputs.forEach(input => {
        input.addEventListener('input', updateJsonData);
    });
    
    // Event-Listener für die Select-Elemente hinzufügen
    const materialSelects = newRow.querySelector('.material-name');
    materialSelects.addEventListener('change', updateJsonData);
    
    updateMaterialRemoveButtons();
}
function updateMaterialRemoveButtons() {
    const rows = document.querySelectorAll('#material-table tbody tr');
    rows.forEach((row, index) => {
        const btn = row.querySelector('.remove-material-btn');
        if (rows.length > 1) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
    });
}

// Diese Funktion sollte aufgerufen werden, wenn das Formular abgesendet wird
// Also update the collectMaterialData function to filter out "Bitte auswählen" rows
function collectMaterialData() {
    const materialData = [];
    const rows = document.querySelectorAll('#material-table tbody tr');
    
    rows.forEach(row => {
        const materialSelect = row.querySelector('.material-name');
        const quantityInput = row.querySelector('.material-quantity');
        
        // Get the displayed text
        let materialText = "";
        if (materialSelect.tagName === 'SELECT') {
            const selectedOption = materialSelect.options[materialSelect.selectedIndex];
            materialText = selectedOption ? selectedOption.text : "";
        } else {
            materialText = materialSelect.value;
        }
        
        const quantity = quantityInput.value.trim();
        
        // Only add if it's not "Bitte auswählen" and at least one field is filled
        if ((materialText && materialText !== "Bitte auswählen") || quantity) {
            materialData.push({
                material: materialText,
                menge: quantity
            });
        }
    });
    
    return materialData;
}

// Funktion zum Laden vorhandener Materialdaten ins Modal
function loadMaterialData() {
    const tbody = document.querySelector('#material-table tbody');
    tbody.innerHTML = ''; // Tabelle leeren
    
    let materialData = [];
    try {
        const materialDataJson = document.getElementById('material_data').value;
        if (materialDataJson) {
            materialData = JSON.parse(materialDataJson);
        }
    } catch (e) {
        console.error('Fehler beim Parsen der Material-Daten:', e);
        materialData = [];
    }
    
    // Wenn keine Daten vorhanden sind, eine leere Zeile hinzufügen
    if (materialData.length === 0) {
        addMaterialRow();
        return;
    }
    
    // Bestehende Daten laden
    materialData.forEach(item => {
        addMaterialRow();
        const lastRow = tbody.lastElementChild;
        const materialSelect = lastRow.querySelector('.material-name');
        const quantityInput = lastRow.querySelector('.material-quantity');
        
        // Den richtigen Wert im Dropdown finden und auswählen
        if (materialSelect.tagName === 'SELECT') {
            for (let i = 0; i < materialSelect.options.length; i++) {
                if (materialSelect.options[i].text === item.material) {
                    materialSelect.selectedIndex = i;
                    break;
                }
            }
        } else {
            materialSelect.value = item.material;
        }
        
        quantityInput.value = item.menge;
    });
}

// Vor dem Absenden des Formulars ausführen
document.getElementById('timesheet-form').addEventListener('submit', function() {
    const materialData = collectMaterialData();
    document.getElementById('material_data').value = JSON.stringify(materialData);
});
    
    // Arbeitskraft-Feld bearbeitbar machen
    const arbeitskraftField = document.getElementById('arbeitskraft');
    
    // 1. readonly-Attribut entfernen
    arbeitskraftField.removeAttribute('readonly');
    
    // 2. Aussehen anpassen, damit es wie ein normales Eingabefeld aussieht
    arbeitskraftField.style.backgroundColor = "#fff";
    arbeitskraftField.style.cursor = "text";
    
    // 3. Optionalen Platzhalter hinzufügen
    arbeitskraftField.placeholder = "Name(n) der Arbeitskraft(e) eingeben";
    
    // 4. Hilfetext unter dem Feld hinzufügen
    const helpText = document.createElement('div');
    helpText.className = 'form-text';
    helpText.innerHTML = '<small>Mehrere Namen können mit Komma getrennt werden.</small>';
    arbeitskraftField.parentNode.appendChild(helpText);
    
    // 5. Feld in die Tab-Reihenfolge einfügen
    arbeitskraftField.tabIndex = 0;
    
    // JSON-Daten für das Formular sammeln
    function updateJsonData() {
        // Arbeitseinsatz-Daten sammeln
        const arbeitseinsatzData = [];
        document.querySelectorAll('#arbeitseinsatz-table tbody tr').forEach(row => {
            const activity = row.querySelector('.activity-select').value;
            const activityText = row.querySelector('.activity-select option:checked').text;
            const von = row.querySelector('.time-from').value;
            const bis = row.querySelector('.time-to').value;
            const std = row.querySelector('.time-hours').value;
            
            arbeitseinsatzData.push({
                activity: activity,
                activityText: activityText,
                von: von,
                bis: bis,
                std: std
            });
        });
        
        // Material-Daten sammeln
        const materialData = [];
        document.querySelectorAll('#material-table tbody tr').forEach(row => {
            const name = row.querySelector('.material-name').value;
            const quantity = row.querySelector('.material-quantity').value;
            
            if (name || quantity) {
                materialData.push({
                    material: name,
                    menge: quantity
                });
            }
        });
        
        // JSON-Daten in die versteckten Felder eintragen
        document.getElementById('arbeitseinsatz_data').value = JSON.stringify(arbeitseinsatzData);
        document.getElementById('material_data').value = JSON.stringify(materialData);
        
        // Haupt-Aktivität setzen (erste Zeile)
        if (arbeitseinsatzData.length > 0) {
            document.getElementById('activity-hidden').value = arbeitseinsatzData[0].activity;
        }
        
        // Vorschau aktualisieren
        updatePreview();
    }
    
    // Aktivität "Andere" Logik
    function checkForOtherActivity() {
        let hasOtherActivity = false;
        document.querySelectorAll('.activity-select').forEach(select => {
            if (select.value === 'andere') {
                hasOtherActivity = true;
            }
        });
        
        if (hasOtherActivity) {
            document.getElementById('other-activity-div').style.display = 'block';
        } else {
            document.getElementById('other-activity-div').style.display = 'none';
        }
    }
    
    // Vorschau-Funktionalität
   
// Modify the updatePreview function to handle empty material rows better
function updatePreview() {
    // Kopfdaten
    document.getElementById('preview-datum').textContent = document.getElementById('datum').value;
    document.getElementById('preview-bv').textContent = document.getElementById('bauvorhaben').value;
    document.getElementById('preview-arbeitskraft').textContent = document.getElementById('arbeitskraft').value;
    document.getElementById('preview-an-abreise').textContent = document.getElementById('an_abreise').value;

    // Arbeitseinsatz
    const arbeitseinsatzPreview = document.getElementById('preview-arbeitseinsatz');
    arbeitseinsatzPreview.innerHTML = '';
    let totalHours = 0;
    document.querySelectorAll('#arbeitseinsatz-table tbody tr').forEach(row => {
        const activity = row.querySelector('.activity-select option:checked').text;
        const von = row.querySelector('.time-from').value;
        const bis = row.querySelector('.time-to').value;
        const std = parseFloat(row.querySelector('.time-hours').value) || 0;
        totalHours += std;
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>${activity}</td>
            <td>${von}</td>
            <td>${bis}</td>
            <td>${std.toFixed(1)}</td>
        `;
        arbeitseinsatzPreview.appendChild(newRow);
    });
    document.getElementById('preview-stunden-summe').textContent = totalHours.toFixed(1);

    // Material
    const materialPreview = document.getElementById('preview-material');
    materialPreview.innerHTML = '';
    const validMaterialEntries = [];
    document.querySelectorAll('#material-table tbody tr').forEach(row => {
        const materialSelect = row.querySelector('.material-name');
        const quantity = row.querySelector('.material-quantity').value.trim();
        let materialText = "";
        if (materialSelect.tagName === 'SELECT') {
            const selectedOption = materialSelect.options[materialSelect.selectedIndex];
            materialText = selectedOption ? selectedOption.text : "";
        } else {
            materialText = materialSelect.value.trim();
        }
        // Nur gültige Einträge hinzufügen
        if ((materialText && materialText !== "Bitte auswählen") || quantity) {
            validMaterialEntries.push({
                material: materialText,
                quantity: quantity
            });
        }
    });
    // Wenn gültige Materialien vorhanden sind, anzeigen
    if (validMaterialEntries.length > 0) {
        validMaterialEntries.forEach(entry => {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${entry.material}</td>
                <td>${entry.quantity}</td>
            `;
            materialPreview.appendChild(newRow);
        });
    } else {
        // Keine Materialien eingetragen
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
            <td colspan="2" class="text-center text-muted">Keine Materialien eingetragen</td>
        `;
        materialPreview.appendChild(emptyRow);
    }

    // Notizen
    const notes = document.getElementById('{{ form.notes.id }}').value.trim();
    if (notes) {
        document.getElementById('preview-notes-section').style.display = 'block';
        document.getElementById('preview-notes').textContent = notes;
    } else {
        document.getElementById('preview-notes-section').style.display = 'none';
    }
}
    
    // Event-Listener für alle Inputs
    function setupEventListeners() {
        // Inputs im Formular
        const formInputs = document.querySelectorAll('#timesheet-form input, #timesheet-form select, #timesheet-form textarea');
        formInputs.forEach(input => {
            input.addEventListener('input', updateJsonData);
        });
        
        // Arbeitseinsatz-Tabelle
        document.querySelectorAll('.time-from, .time-to').forEach(input => {
            input.addEventListener('change', updateAllHours);
        });
        
        document.querySelectorAll('.activity-select').forEach(select => {
            select.addEventListener('change', checkForOtherActivity);
        });
        
        document.getElementById('add-row-btn').addEventListener('click', addTimeRow);
        document.getElementById('add-material-btn').addEventListener('click', addMaterialRow);
        
        // Material-Eingaben
        const materialInputs = document.querySelectorAll('.material-name, .material-quantity');
        materialInputs.forEach(input => {
            input.addEventListener('input', updateJsonData);
        });
    }
    
    // Zeichenzähler für Notizen
    function setupCharCounter() {
        const notesField = document.getElementById('{{ form.notes.id }}');
        const charCounter = document.getElementById('char-count');
        
        notesField.addEventListener('input', function() {
            const length = this.value.length;
            charCounter.textContent = length;
            
            if (length > 500) {
                charCounter.classList.add('text-danger');
                charCounter.classList.remove('text-muted');
            } else {
                charCounter.classList.remove('text-danger');
                charCounter.classList.add('text-muted');
            }
        });
    }
    
    // Keyboard-Shortcuts
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', function(event) {
            // Strg+S zum Speichern
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                document.getElementById('save-btn').click();
            }
            
            // Strg+P für Vorschau
            if (event.ctrlKey && event.key === 'p') {
                event.preventDefault();
                const previewBtn = document.querySelector('[data-bs-target="#previewModal"]');
                previewBtn.click();
            }
        });
    }
    
    // Form-Validierung
    function setupFormValidation() {
        const form = document.getElementById('timesheet-form');
        
        form.addEventListener('submit', function(event) {
            // Validiere Datum
            const datumInput = document.getElementById('datum');
            if (!datumInput.value) {
                event.preventDefault();
                datumInput.classList.add('is-invalid');
                datumInput.focus();
                return;
            }
            
            // Validiere Arbeitskraft
            const arbeitskraftInput = document.getElementById('arbeitskraft');
            if (!arbeitskraftInput.value.trim()) {
                event.preventDefault();
                arbeitskraftInput.classList.add('is-invalid');
                arbeitskraftInput.focus();
                return;
            }
            
            // Validiere Stunden
            const totalHours = parseFloat(document.querySelector('.total-hours').value);
            if (totalHours <= 0) {
                event.preventDefault();
                alert('Bitte tragen Sie mindestens eine Tätigkeit mit gültiger Zeiterfassung ein.');
                return;
            }
            
            // Validiere 'Andere Tätigkeit', falls ausgewählt
            const hasOtherActivity = Array.from(document.querySelectorAll('.activity-select')).some(select => select.value === 'andere');
            if (hasOtherActivity) {
                const otherActivityInput = document.getElementById('{{ form.other_activity.id }}');
                if (!otherActivityInput.value.trim()) {
                    event.preventDefault();
                    otherActivityInput.classList.add('is-invalid');
                    otherActivityInput.focus();
                    return;
                }
            }
        });
    }
    
    // Bestätigungsdialog vor dem Verlassen der Seite
    function setupLeaveConfirmation() {
        let formChanged = false;
        
        // Überwachen aller Eingaben
        const formInputs = document.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.addEventListener('change', function() {
                formChanged = true;
            });
        });
        
        // Bestätigungsdialog anzeigen
        window.addEventListener('beforeunload', function(event) {
            if (formChanged) {
                event.preventDefault();
                event.returnValue = 'Sie haben ungespeicherte Änderungen. Möchten Sie die Seite wirklich verlassen?';
                return event.returnValue;
            }
        });
        
        // Bestätigung beim Abbrechen-Button deaktivieren
        document.querySelector('a.btn-outline-secondary').addEventListener('click', function() {
            formChanged = false;
        });
        
        // Bestätigung beim Speichern-Button deaktivieren
        document.getElementById('save-btn').addEventListener('click', function() {
            formChanged = false;
        });
    }
    
    // Datum automatisch auf heute setzen
    function setDateToday() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        
        const datumInput = document.getElementById('datum');
        if (!datumInput.value) {
            datumInput.value = `${year}-${month}-${day}`;
        }
    }
    
    // Funktion für automatische Zeit-Vorschläge
    function setupTimeAutocomplete() {
        // Vorschläge für gängige Arbeitszeiten
        const commonStartTimes = ['07:00', '07:30', '08:00', '08:30', '09:00'];
        const commonEndTimes = ['16:00', '16:30', '17:00', '17:30', '18:00'];
        
        // Datalist für Von-Zeit
        const fromDatalistId = 'time-from-options';
        let fromDatalist = document.getElementById(fromDatalistId);
        
        if (!fromDatalist) {
            fromDatalist = document.createElement('datalist');
            fromDatalist.id = fromDatalistId;
            document.body.appendChild(fromDatalist);
            
            commonStartTimes.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                fromDatalist.appendChild(option);
            });
        }
        
        // Datalist für Bis-Zeit
        const toDatalistId = 'time-to-options';
        let toDatalist = document.getElementById(toDatalistId);
        
        if (!toDatalist) {
            toDatalist = document.createElement('datalist');
            toDatalist.id = toDatalistId;
            document.body.appendChild(toDatalist);
            
            commonEndTimes.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                toDatalist.appendChild(option);
            });
        }
        
        // Datalist den Eingabefeldern zuweisen
        document.querySelectorAll('.time-from').forEach(input => {
            input.setAttribute('list', fromDatalistId);
        });
        
        document.querySelectorAll('.time-to').forEach(input => {
            input.setAttribute('list', toDatalistId);
        });
    }
    
    // Autosave-Funktion
    function setupAutosave() {
        const AUTOSAVE_KEY = 'timesheet_autosave_' + window.location.pathname;
        const AUTOSAVE_INTERVAL = 30000; // 30 Sekunden
        
        // Wiederherstellen von Autosave-Daten
        try {
            const savedData = localStorage.getItem(AUTOSAVE_KEY);
            if (savedData) {
                const data = JSON.parse(savedData);
                
                // Datum und Kopfdaten wiederherstellen
                if (data.date) document.getElementById('datum').value = data.date;
                if (data.arbeitskraft) document.getElementById('arbeitskraft').value = data.arbeitskraft;
                if (data.an_abreise) document.getElementById('an_abreise').value = data.an_abreise;
                
                // Arbeitseinsatz wiederherstellen
                if (data.arbeitseinsatz && data.arbeitseinsatz.length > 0) {
                    // Erste Zeile füllen
                    const firstRow = document.querySelector('#arbeitseinsatz-table tbody tr');
                    firstRow.querySelector('.activity-select').value = data.arbeitseinsatz[0].activity;
                    firstRow.querySelector('.time-from').value = data.arbeitseinsatz[0].von;
                    firstRow.querySelector('.time-to').value = data.arbeitseinsatz[0].bis;
                    
                    // Weitere Zeilen hinzufügen
                    for (let i = 1; i < data.arbeitseinsatz.length; i++) {
                        addTimeRow();
                        const row = document.querySelectorAll('#arbeitseinsatz-table tbody tr')[i];
                        row.querySelector('.activity-select').value = data.arbeitseinsatz[i].activity;
                        row.querySelector('.time-from').value = data.arbeitseinsatz[i].von;
                        row.querySelector('.time-to').value = data.arbeitseinsatz[i].bis;
                    }
                }
                
                // Material wiederherstellen
                if (data.material && data.material.length > 0) {
                    // Erste Zeile füllen
                    const firstRow = document.querySelector('#material-table tbody tr');
                    firstRow.querySelector('.material-name').value = data.material[0].material;
                    firstRow.querySelector('.material-quantity').value = data.material[0].menge;
                    
                    // Weitere Zeilen hinzufügen
                    for (let i = 1; i < data.material.length; i++) {
                        addMaterialRow();
                        const row = document.querySelectorAll('#material-table tbody tr')[i];
                        row.querySelector('.material-name').value = data.material[i].material;
                        row.querySelector('.material-quantity').value = data.material[i].menge;
                    }
                }
                
                // Notizen wiederherstellen
                if (data.notes) document.getElementById('{{ form.notes.id }}').value = data.notes;
                
                // Interface aktualisieren
                updateAllHours();
                checkForOtherActivity();
                
                // Autosave-Info anzeigen
                const autosaveInfo = document.createElement('div');
                autosaveInfo.className = 'alert alert-info animate__animated animate__fadeIn';
                autosaveInfo.innerHTML = `
                    <i class="fas fa-history me-2"></i>
                    <strong>Automatisch gespeicherte Daten wiederhergestellt.</strong>
                    <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Schließen"></button>
                `;
                document.querySelector('.card-body').insertBefore(autosaveInfo, document.querySelector('form'));
                
                // Alert nach 5 Sekunden ausblenden
                setTimeout(() => {
                    autosaveInfo.classList.add('animate__fadeOut');
                    setTimeout(() => autosaveInfo.remove(), 500);
                }, 5000);
            }
        } catch (error) {
            console.error('Fehler beim Wiederherstellen der Autosave-Daten:', error);
        }
        
        // Regelmäßiges Speichern
        setInterval(() => {
            try {
                // Daten sammeln
                const data = {
                    date: document.getElementById('datum').value,
                    arbeitskraft: document.getElementById('arbeitskraft').value,
                    an_abreise: document.getElementById('an_abreise').value,
                    arbeitseinsatz: JSON.parse(document.getElementById('arbeitseinsatz_data').value || '[]'),
                    material: JSON.parse(document.getElementById('material_data').value || '[]'),
                    notes: document.getElementById('{{ form.notes.id }}').value
                };
                
                // Im LocalStorage speichern
                localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
            } catch (error) {
                console.error('Fehler beim Autosave:', error);
            }
        }, AUTOSAVE_INTERVAL);
        
        // Beim erfolgreichen Absenden des Formulars Autosave löschen
        document.getElementById('timesheet-form').addEventListener('submit', function() {
            localStorage.removeItem(AUTOSAVE_KEY);
        });
    }
    
    // Alle Initialisierungen starten
    setupEventListeners();
    setupCharCounter();
    setupKeyboardShortcuts();
    setupFormValidation();
    setupLeaveConfirmation();
    setDateToday();
    setupTimeAutocomplete();
    setupAutosave();
    
    // Initialen Zustand aktualisieren
    updateAllHours();
    updateJsonData();
    updateRemoveButtons();
    updateMaterialRemoveButtons();
    checkForOtherActivity();
    
    // Modal-Events für die Vorschau
    const previewModal = document.getElementById('previewModal');
    previewModal.addEventListener('show.bs.modal', updatePreview);
});
document.addEventListener('DOMContentLoaded', function() {
    // Alle Formularelemente auswählen
    const inputs = document.querySelectorAll('.form-control, .form-select');
    
    // Stile anwenden
    inputs.forEach(input => {
        input.style.setProperty('background-color', '#14304d', 'important');
        input.style.setProperty('color', 'var(--accent)', 'important');
    });
    
    // Auch auf neue Elemente anwenden, die später hinzugefügt werden
    const observer = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
            if (mutation.addedNodes) {
                mutation.addedNodes.forEach(node => {
                    if (node.querySelectorAll) {
                        const newInputs = node.querySelectorAll('.form-control, .form-select');
                        newInputs.forEach(input => {
                            input.style.setProperty('background-color', '#14304d', 'important');
                            input.style.setProperty('color', 'var(--accent)', 'important');
                        });
                    }
                });
            }
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
});
</script>
<script>
    // Funktion um zu prüfen, ob "Andere Materialien" ausgewählt wurde
    function checkForOtherMaterial() {
        const materialSelects = document.querySelectorAll('.material-name');
        const otherMaterialDiv = document.getElementById('other-material-div');
        
        // Prüfen, ob irgendeine der Material-Selects "Andere Materialien" enthält
        let hasOtherMaterial = false;
        materialSelects.forEach(select => {
            if (select.value === 'other') {
                hasOtherMaterial = true;
            }
        });
        
        // Ein-/Ausblenden des "Andere Materialien"-Felds
        otherMaterialDiv.style.display = hasOtherMaterial ? 'block' : 'none';
        
        // Wenn keine "Andere Materialien" ausgewählt sind, das Feld leeren
        if (!hasOtherMaterial) {
            document.getElementById('{{ form.other_material.id }}').value = '';
        }
    }
    
    // Event-Listener nach dem Laden der Seite hinzufügen
    document.addEventListener('DOMContentLoaded', function() {
        // Initial-Check durchführen
        checkForOtherMaterial();
        
        // Event-Listener für Material-Selects
        const materialTable = document.getElementById('material-table');
        
        // Event-Delegation verwenden
        materialTable.addEventListener('change', function(event) {
            if (event.target.classList.contains('material-name')) {
                checkForOtherMaterial();
            }
        });
        
        // Event-Listener für "Material hinzufügen"-Button
        document.getElementById('add-material-btn').addEventListener('click', function() {
            // Zeitverzögerung, um dem DOM Zeit zu geben, die neuen Elemente zu rendern
            setTimeout(checkForOtherMaterial, 10);
        });
    });
    // Add this JavaScript to your page (in a <script> tag or external JS file)
document.addEventListener('DOMContentLoaded', function() {
    // Ensure hidden fields stay hidden (in case CSS is overriding them)
    const hiddenFields = [
        'arbeitseinsatz_data',
        'material_data',
        'activity-hidden',
        'material-hidden'
    ];
    
    hiddenFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            // Force hide with inline style
            element.style.display = 'none';
            element.style.position = 'absolute';
            element.style.left = '-9999px';
        }
    });
});
    </script>

{% endblock %}