<!-- app/templates/timesheets/new_fortuna.html -->
{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/new_fortuna.css') }}">
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-lg">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #14304d; color: var(--accent)">
                    <h3 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>Bau-Tagesbericht und Stundennachweis
                    </h3>
                    <span class="badge" style="background-color: #14304d; color: var(--accent)">{{ project.name }}</span>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted mb-4">Erfassen Sie Ihren Bau-Tagesbericht für das Projekt "{{ project.name }}"</p>

                    <form method="POST" action="{{ url_for('timesheets.new_timesheet', project_id=project.id) }}" id="timesheet-form">
                        {{ form.hidden_tag() }}
                        
                        <!-- Fortuna Elektro Kopfdaten -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="datum" class="form-label fw-bold">Datum:</label>
                                    {{ form.date(class="form-control" + (" is-invalid" if form.date.errors else ""), type="date", id="datum") }}
                                    {% if form.date.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bauvorhaben" class="form-label fw-bold">BV (Bauvorhaben):</label>
                                    <input type="text" class="form-control" id="bauvorhaben" name="bauvorhaben" value="{{ project.name }}" readonly>
                                </div>
                            
                                <div class="mb-3">
                                    <label for="arbeitskraft" class="form-label fw-bold">Arbeitskraft:</label>
                                    <input style="background-color: #14304d; color: var(--accent)" type="text" class="form-control" id="arbeitskraft" name="arbeitskraft" value="{{ current_user.username }}" placeholder="Name(n) der Arbeitskraft(e) eingeben">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="an_abreise" class="form-label fw-bold">An-u. Abreise:</label>
                                    <input type="text" class="form-control" id="an_abreise" name="an_abreise" placeholder="z.B. '07:45 - 17:15'">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="p-3 h-100 rounded" style="background-color: #14304d; color: var(--accent)">
                                    <div class="text-center mb-3">
                                        <img src="/static/img/logo_new1.png" alt="Fortuna Elektro GmbH" class="img-fluid" style="max-height: 50px;">
                                    </div>
                                    <div class="text-center">
                                        <p class="mb-1"><strong>Fortuna Elektro GmbH</strong></p>
                                        <p class="mb-1">Lothar-Bucher-Straße 5</p>
                                        <p class="mb-1">12157 Berlin</p>
                                        <p class="mb-1">+49 (030) 499 657 15</p>
                                        <p class="mb-0">info@fortuna-elektro.com</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Arbeitseinsatz-Tabelle -->
                        <h5 class="mb-3"><i class="far fa-clock me-2"></i>Arbeitseinsatz</h5>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered" id="arbeitseinsatz-table" style="background-color: #14304d; color: var(--accent)">
                                <thead class="table" style="background-color: #14304d; color: var(--accent)">
                                    <tr style="background-color: #14304d; color: var(--accent)">
                                        <th style="width: 40%">Tätigkeit</th>
                                        <th>Von</th>
                                        <th>Bis</th>
                                        <th>Std</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <select class="form-select activity-select" style="background-color: #14304d !important; color: var(--accent) !important;">
                                                {% for value, label in form.activity.choices %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="time" class="form-control time-from" value="00:00" style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="time" class="form-control time-to" value="00:00" style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="text" class="form-control time-hours" value="0.0" readonly style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td class="text-center" style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" style="display:none;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end fw-bold" style="background-color: #14304d; color: var(--accent)">Gesamtstunden:</td>
                                        <td style="background-color: #14304d; color: var(--accent)">
                                            {{ form.hours(class="form-control total-hours" + (" is-invalid" if form.hours.errors else ""), readonly=true) }}
                                            {% if form.hours.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in form.hours.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td style="background-color: #14304d; color: var(--accent)"></td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="text-end">
                                <button type="button" class="btn btn-sm btn-primary" id="add-row-btn">
                                    <i class="fas fa-plus me-1"></i>Zeile hinzufügen
                                </button>
                            </div>
                        </div>
                        
                        <!-- Andere Tätigkeit Box (erscheint wenn 'Andere' ausgewählt) -->
                        <div id="other-activity-div" style="display:none;" class="mb-4 animate__animated animate__fadeIn">
                            <label for="{{ form.other_activity.id }}" class="form-label fw-bold">
                                <i class="fas fa-edit me-2"></i>{{ form.other_activity.label.text }}
                            </label>
                            {{ form.other_activity(class="form-control" + (" is-invalid" if form.other_activity.errors else ""), placeholder="Bitte geben Sie Ihre Tätigkeit ein...") }}
                            {% if form.other_activity.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.other_activity.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Material-Tabelle -->
                        <h5 class="mb-3"><i class="fas fa-tools me-2"></i>Material</h5>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered" id="material-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 70%">Material</th>
                                        <th>Menge</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <select class="form-select material-name" style="background-color: #14304d !important; color: var(--accent) !important;">
                                                <option value="">Bitte auswählen</option>
                                                {% for value, label in material_choices %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <input type="text" class="form-control material-quantity" placeholder="z.B. 25m" style="background-color: #14304d !important; color: var(--accent) !important;">
                                        </td>
                                        <td class="text-center" style="background-color: #14304d !important; color: var(--accent) !important;">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-material-btn">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="text-end">
                                <button type="button" class="btn btn-sm btn-primary" id="add-material-btn">
                                    <i class="fas fa-plus me-1"></i>Material hinzufügen
                                </button>
                            </div>
                        </div>
                        
                        <!-- Andere Materialien Box (erscheint wenn 'Andere Materialien' ausgewählt) -->
                        <div id="other-material-div" style="display:none;" class="mb-4 animate__animated animate__fadeIn">
                            <label for="{{ form.other_material.id }}" class="form-label fw-bold">
                                <i class="fas fa-edit me-2"></i>{{ form.other_material.label.text }}
                            </label>
                            {{ form.other_material(class="form-control" + (" is-invalid" if form.other_material.errors else ""), placeholder="Bitte geben Sie das Material ein...") }}
                            {% if form.other_material.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.other_material.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Notizen mit Markdown-Hinweis -->
                        <div class="mb-4">
                            <label for="{{ form.notes.id }}" class="form-label fw-bold">
                                <i class="fas fa-sticky-note me-2"></i>{{ form.notes.label.text }}
                            </label>
                            <div class="notes-container position-relative">
                                {{ form.notes(class="form-control" + (" is-invalid" if form.notes.errors else ""), rows=4, placeholder="Zusätzliche Informationen zum Bau-Tagesbericht...") }}
                                <div class="character-counter small text-muted position-absolute bottom-0 end-0 m-2">
                                    <span id="char-count">0</span>/500
                                </div>
                            </div>
                            <div class="form-text">
                                <small>Markdown wird unterstützt. Verwenden Sie *kursiv* oder **fett** für Formatierungen.</small>
                            </div>
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Versteckte Felder für Arbeitseinsatz und Material JSON-Daten -->
                        <input type="hidden" name="arbeitseinsatz_data" id="arbeitseinsatz_data">
                        <input type="hidden" name="material_data" id="material_data" value="[]">
                        {{ form.activity(type="hidden", id="activity-hidden") }}
                        {{ form.material(type="hidden", id="material-hidden") }}
                        
                        <hr class="my-4">
                        
                        <!-- Speichern-Button mit Keyboard Shortcut -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-2"></i>Abbrechen
                            </a>
                            <button type="submit" class="btn btn-primary" id="save-btn">
                                <i class="fas fa-save me-2"></i>PDF erstellen und speichern
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer bg-light py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small text-muted">
                            <i class="fas fa-info-circle me-1"></i> Alle Felder werden für die PDF-Erstellung verwendet
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary" style="background-color: #14304d; color: var(--accent)" data-bs-toggle="modal" data-bs-target="#previewModal">
                                <i class="fas fa-eye me-1"></i>Vorschau
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Improved Mobile-Responsive Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-fullscreen-sm-down">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="previewModalLabel">PDF Vorschau</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
          </div>
          <div class="modal-body modal-body-scrollable">
              <div class="preview-content p-3">
                  <!-- Header -->
                  <div class="row mb-3">
                      <div class="col-md-7 col-sm-12">
                          <div class="mb-1"><strong>Datum:</strong> <span id="preview-datum"></span></div>
                          <div class="mb-1"><strong>BV:</strong> <span id="preview-bv"></span></div>
                          <div class="mb-1"><strong>Arbeitskraft:</strong> <span id="preview-arbeitskraft"></span></div>
                          <div><strong>An-u. Abreise:</strong> <span id="preview-an-abreise"></span></div>
                      </div>
                      <div class="col-md-5 col-sm-12 mt-sm-3 mt-md-0">
                          <div class="text-md-end text-sm-center">
                              <div class="text-center mb-2">
                                  <img src="/static/img/fortuna-logo.png" alt="Fortuna Elektro GmbH" class="img-fluid" style="max-height: 40px;">
                              </div>
                              <p class="mb-0"><strong>Fortuna Elektro GmbH</strong></p>
                              <p class="mb-0 company-details">Lothar-Bucher-Straße 5</p>
                              <p class="mb-0 company-details">12157 Berlin</p>
                              <p class="mb-0 company-details">+49 (030) 499 657 15</p>
                              <p class="mb-0 company-details">info@fortuna-elektro.com</p>
                          </div>
                      </div>
                  </div>
                  
                  <h4 class="text-center mb-3">Bau-Tagesbericht und Stundennachweis</h4>
                  
                  <!-- Arbeitseinsatz -->
                  <h5 class="mb-2"><i class="far fa-clock me-1"></i>Arbeitseinsatz</h5>
                  <div class="table-responsive">
                      <table class="table table-bordered table-sm mb-3">
                          <thead class="table-light">
                              <tr>
                                  <th>Tätigkeit</th>
                                  <th>von</th>
                                  <th>bis</th>
                                  <th>Std</th>
                              </tr>
                          </thead>
                          <tbody id="preview-arbeitseinsatz">
                              <!-- Wird per JavaScript befüllt -->
                          </tbody>
                          <tfoot>
                              <tr>
                                  <td colspan="3" class="text-end"><strong>Gesamtstunden:</strong></td>
                                  <td id="preview-stunden-summe"></td>
                              </tr>
                          </tfoot>
                      </table>
                  </div>
                 
                  <!-- Material -->
                  <h5 class="mb-2"><i class="fas fa-tools me-1"></i>Material</h5>
                  <div class="table-responsive">
                      <table class="table table-bordered table-sm mb-3">
                          <thead class="table-light">
                              <tr>
                                  <th style="width: 70%">Material</th>
                                  <th>Menge</th>
                              </tr>
                          </thead>
                          <tbody id="preview-material">
                              <!-- Wird per JavaScript befüllt -->
                          </tbody>
                      </table>
                  </div>
                  
                  <!-- Notizen -->
                  <div id="preview-notes-section" style="display:none;">
                      <h5 class="mb-2"><i class="far fa-sticky-note me-1"></i>Notizen</h5>
                      <div class="p-2 bg-light rounded" id="preview-notes"></div>
                  </div>
              </div>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
          </div>
      </div>
  </div>
</div>

<!-- CSS to override any existing styles -->
<style>
  #previewModal .modal-content {
      background-color: #fff !important;
  }
  
  #previewModal .modal-body, 
  #previewModal .preview-content,
  #previewModal .modal-footer {
      background-color: #fff !important;
      color: #212529 !important;
  }
  
  #previewModal .text-dark,
  #previewModal tbody,
  #previewModal tfoot,
  #previewModal p,
  #previewModal h4,
  #previewModal h5,
  #previewModal strong,
  #previewModal span {
      color: #212529 !important;
  }
  
  #previewModal thead {
      background-color: #343a40 !important;
      color: #fff !important;
  }
  
  #previewModal .company-details {
      color: #212529 !important;
  }
  
  /* Mobile adjustments */
  @media (max-width: 767px) {
      #previewModal .modal-body-scrollable {
          background-color: #fff !important;
      }
      
      #previewModal table, 
      #previewModal td,
      #previewModal th {
          border-color: #dee2e6 !important;
      }
  }
</style>
<style>
  /* Nur Mobile-Styling - Desktop bleibt unverändert */
  @media (max-width: 767.98px) {
    /* Modal-Anpassungen für Mobilgeräte */
    .modal-dialog {
      margin: 0.25rem;
      max-width: 95%;
    }
    
    .modal-content {
      border-radius: 0.3rem;
    }
    
    .modal-header {
      padding: 0.5rem !important;
    }
    
    .modal-body {
      padding: 0 !important;
    }
    
    .modal-footer {
      padding: 0.5rem !important;
    }
    
    /* Inhalt kompakter machen */
    .preview-content {
      padding: 5px !important;
      font-size: 0.65rem !important;
      transform: scale(0.95);
      transform-origin: top center;
    }
    
    /* Überschriften und Text kompakter */
    .preview-content h4 {
      font-size: 0.9rem !important;
      margin: 0.3rem 0 !important;
    }
    
    .preview-content h5 {
      font-size: 0.75rem !important;
      margin: 0.2rem 0 !important;
    }
    
    /* Abstände reduzieren */
    .preview-content .mb-3 {
      margin-bottom: 0.3rem !important;
    }
    
    .preview-content .mb-2 {
      margin-bottom: 0.2rem !important;
    }
    
    .preview-content .mb-1 {
      margin-bottom: 0.1rem !important;
    }
    
    /* Firmeninformationen */
    .preview-content .company-details {
      font-size: 0.6rem !important;
      line-height: 1.1 !important;
      margin-bottom: 0 !important;
    }
    
    /* Logo */
    .preview-content img.img-fluid {
      max-height: 30px !important;
    }
    
    /* Tabellen kompakter */
    .preview-content table {
      margin-bottom: 0.3rem !important;
    }
    
    .preview-content th,
    .preview-content td {
      padding: 0.15rem !important;
      font-size: 0.65rem !important;
      background-color: #fff !important;
    }
    
    /* Gesamtlook wie ein A4-Blatt */
    .modal-body-scrollable {
      max-height: none !important;
      overflow: visible !important;
    }
  }
  </style>
<script>
  /* JavaScript to enhance the UI structure */
document.addEventListener('DOMContentLoaded', function() {
    // Wrap gesamtstunden in a container for better styling
    const gesamtstundenText = document.querySelector('td:contains("Gesamtstunden:")');
    if (gesamtstundenText) {
        const parent = gesamtstundenText.parentNode;
        const container = document.createElement('div');
        container.className = 'gesamtstunden-container';
        
        const label = document.createElement('span');
        label.id = 'gesamtstunden-label';
        label.textContent = 'Gesamtstunden:';
        
        const value = document.createElement('span');
        value.id = 'gesamtstunden-value';
        value.textContent = document.getElementById('preview-stunden-summe').textContent || '0.0';
        
        container.appendChild(label);
        container.appendChild(value);
        
        // Replace or append accordingly
        if (parent) {
            parent.innerHTML = '';
            parent.appendChild(container);
        } else {
            // If parent not found, add after the table
            const table = document.getElementById('arbeitseinsatz-table');
            if (table) {
                table.parentNode.insertBefore(container, table.nextSibling);
            }
        }
    }
    
    // Make add buttons more visible
    const addRowBtn = document.getElementById('add-row-btn');
    if (addRowBtn && !addRowBtn.textContent.includes('+')) {
        addRowBtn.innerHTML = '<span>+ ZEILE HINZUFÜGEN</span>';
    }
    
    const addMaterialBtn = document.getElementById('add-material-btn');
    if (addMaterialBtn && !addMaterialBtn.textContent.includes('+')) {
        addMaterialBtn.innerHTML = '<span>+ MATERIAL HINZUFÜGEN</span>';
    }
});
  
document.addEventListener('DOMContentLoaded', function() {
  // Utility functions
  const $ = selector => document.querySelector(selector);
  const $$ = selector => document.querySelectorAll(selector);
  
  // Time calculation
  function calculateHours(timeFrom, timeTo) {
    if (!timeFrom || !timeTo) return 0;
    
    const [fromHours, fromMinutes] = timeFrom.split(':').map(Number);
    const [toHours, toMinutes] = timeTo.split(':').map(Number);
    
    let hours = toHours - fromHours;
    let minutes = toMinutes - fromMinutes;
    
    if (minutes < 0) {
      hours--;
      minutes += 60;
    }
    
    return hours + (minutes / 60);
  }
  
  // Update all timesheet hours
  function updateAllHours() {
    let totalHours = 0;
    
    $$('#arbeitseinsatz-table tbody tr').forEach(row => {
      const timeFrom = row.querySelector('.time-from').value;
      const timeTo = row.querySelector('.time-to').value;
      const hours = calculateHours(timeFrom, timeTo);
      
      row.querySelector('.time-hours').value = hours.toFixed(1);
      totalHours += hours;
    });
    
    $('.total-hours').value = totalHours.toFixed(1);
    updateJsonData();
  }
  
  // Add row to timesheet table
  function addTimeRow() {
    const tbody = $('#arbeitseinsatz-table tbody');
    const originalSelect = $('.activity-select');
    const optionsHTML = Array.from(originalSelect.options)
      .map(opt => `<option value="${opt.value}">${opt.text}</option>`)
      .join('');
    
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
      <td>
        <select class="form-select activity-select">
          ${optionsHTML}
        </select>
      </td>
      <td>
        <input type="time" class="form-control time-from" value="00:00" list="time-from-options">
      </td>
      <td>
        <input type="time" class="form-control time-to" value="00:00" list="time-to-options">
      </td>
      <td>
        <input type="text" class="form-control time-hours" value="0.0" readonly>
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn">
          <i class="fas fa-times"></i>
        </button>
      </td>
    `;
    
    tbody.appendChild(newRow);
    
    // Add event listeners to new row
    const timeFromInput = newRow.querySelector('.time-from');
    const timeToInput = newRow.querySelector('.time-to');
    const activitySelect = newRow.querySelector('.activity-select');
    const removeBtn = newRow.querySelector('.remove-row-btn');
    
    timeFromInput.addEventListener('change', updateAllHours);
    timeToInput.addEventListener('change', updateAllHours);
    activitySelect.addEventListener('change', checkForOtherActivity);
    removeBtn.addEventListener('click', function() {
      tbody.removeChild(newRow);
      updateAllHours();
      updateRemoveButtons();
    });
    
    // Apply dark theme
    applyDarkStyles(newRow);
    
    updateAllHours();
    updateRemoveButtons();
  }
  
  // Add material row
  function addMaterialRow() {
    const tbody = $('#material-table tbody');
    const newRow = document.createElement('tr');
    
    newRow.innerHTML = `
      <td>
        <select class="form-select material-name">
          <option value="">Bitte auswählen</option>
          {% for value, label in material_choices %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
          <option value="other">Andere Materialien</option>
        </select>
      </td>
      <td>
        <input type="text" class="form-control material-quantity" placeholder="z.B. 25m">
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-outline-danger remove-material-btn">
          <i class="fas fa-times"></i>
        </button>
      </td>
    `;
    
    tbody.appendChild(newRow);
    
    // Apply dark theme
    applyDarkStyles(newRow);
    
    // Add event listeners
    const materialSelect = newRow.querySelector('.material-name');
    const quantityInput = newRow.querySelector('.material-quantity');
    const removeBtn = newRow.querySelector('.remove-material-btn');
    
    materialSelect.addEventListener('change', function() {
      checkForOtherMaterial();
      updateJsonData();
    });
    
    quantityInput.addEventListener('input', updateJsonData);
    
    removeBtn.addEventListener('click', function() {
      if (tbody.children.length > 1) {
        tbody.removeChild(newRow);
      } else {
        materialSelect.value = "";
        quantityInput.value = "";
      }
      checkForOtherMaterial();
      updateJsonData();
    });
    
    updateMaterialRemoveButtons();
    checkForOtherMaterial();
  }
  
  // Update button visibility
  function updateRemoveButtons() {
    const rows = $$('#arbeitseinsatz-table tbody tr');
    rows.forEach(row => {
      const btn = row.querySelector('.remove-row-btn');
      btn.style.display = rows.length > 1 ? 'block' : 'none';
    });
  }
  
  function updateMaterialRemoveButtons() {
    const rows = $$('#material-table tbody tr');
    rows.forEach(row => {
      const btn = row.querySelector('.remove-material-btn');
      btn.style.display = rows.length > 1 ? 'block' : 'none';
    });
  }
  
  // Check for "other" field selections
  function checkForOtherActivity() {
    const hasOtherActivity = Array.from($$('.activity-select')).some(select => select.value === 'andere');
    const otherActivityDiv = $('#other-activity-div');
    
    otherActivityDiv.style.display = hasOtherActivity ? 'block' : 'none';
    
    if (hasOtherActivity) {
      const otherActivityInput = $('#{{ form.other_activity.id }}');
      otherActivityInput.addEventListener('input', updateJsonData);
    }
    
    updateJsonData();
  }
  
  function checkForOtherMaterial() {
    const hasOtherMaterial = Array.from($$('.material-name')).some(select => select.value === 'other');
    const otherMaterialDiv = $('#other-material-div');
    
    otherMaterialDiv.style.display = hasOtherMaterial ? 'block' : 'none';
    
    if (hasOtherMaterial) {
      const otherMaterialInput = $('#{{ form.other_material.id }}');
      otherMaterialInput.addEventListener('input', updateJsonData);
    }
    
    updateJsonData();
  }
  
  // Collect data for JSON
function collectMaterialData() {
  const materialData = [];
  
  $$('#material-table tbody tr').forEach(row => {
    const materialSelect = row.querySelector('.material-name');
    const quantityInput = row.querySelector('.material-quantity');
    
    if (materialSelect.value === "") return;
    
    let materialText;
    if (materialSelect.value === 'other') {
      materialText = $('#{{ form.other_material.id }}').value.trim() || "Andere Materialien";
    } else {
      const selectedOption = materialSelect.options[materialSelect.selectedIndex];
      materialText = selectedOption ? selectedOption.text : "";
    }
    
    const quantity = quantityInput.value.trim();
    
    if ((materialText && materialText !== "Bitte auswählen") || quantity) {
      materialData.push({
        material: materialText, // IMPORTANT: Use the display text here, not the ID
        materialText: materialText,
        menge: quantity
      });
    }
  });
  
  return materialData;
}
  
  // Update JSON data fields
function updateJsonData() {
  try {
    // Collect timesheet data
    const arbeitseinsatzData = [];
    
    $$('#arbeitseinsatz-table tbody tr').forEach(row => {
      const activitySelect = row.querySelector('.activity-select');
      const activity = activitySelect.value;
      
      let activityText;
      if (activity === 'andere') {
        activityText = $('#{{ form.other_activity.id }}').value.trim() || "Andere Tätigkeit";
      } else {
        activityText = activitySelect.options[activitySelect.selectedIndex].text;
      }
      
      const von = row.querySelector('.time-from').value;
      const bis = row.querySelector('.time-to').value;
      const std = row.querySelector('.time-hours').value;
      
      arbeitseinsatzData.push({
        activity: activity,
        activityText: activityText,
        von: von,
        bis: bis,
        std: std
      });
    });
    
    // Collect material data
    const materialData = collectMaterialData();
    
    // Update hidden fields
    $('#arbeitseinsatz_data').value = JSON.stringify(arbeitseinsatzData);
    $('#material_data').value = JSON.stringify(materialData);
    
    // Set main activity
    if (arbeitseinsatzData.length > 0 && $('#activity-hidden')) {
      $('#activity-hidden').value = arbeitseinsatzData[0].activity;
    }
    
    // Update preview
    updatePreview();
  } catch (error) {
    console.error("Error in updateJsonData:", error);
  }
}
  
  // Update preview modal
  function updatePreview() {
    $('#preview-datum').textContent = $('#datum').value;
    $('#preview-bv').textContent = $('#bauvorhaben').value;
    $('#preview-arbeitskraft').textContent = $('#arbeitskraft').value;
    $('#preview-an-abreise').textContent = $('#an_abreise').value;
    
    // Timesheet preview
    const arbeitseinsatzPreview = $('#preview-arbeitseinsatz');
    arbeitseinsatzPreview.innerHTML = '';
    let totalHours = 0;
    
    let arbeitseinsatzData = [];
    try {
      arbeitseinsatzData = JSON.parse($('#arbeitseinsatz_data').value || '[]');
    } catch (e) {
      console.error('Error parsing timesheet data:', e);
    }
    
    arbeitseinsatzData.forEach(item => {
      const activityText = item.activityText;
      const von = item.von;
      const bis = item.bis;
      const std = parseFloat(item.std) || 0;
      totalHours += std;
      
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td>${activityText}</td>
        <td>${von}</td>
        <td>${bis}</td>
        <td>${std.toFixed(1)}</td>
      `;
      arbeitseinsatzPreview.appendChild(newRow);
    });
    
    $('#preview-stunden-summe').textContent = totalHours.toFixed(1);
    
    // Material preview
    const materialPreview = $('#preview-material');
    materialPreview.innerHTML = '';
    
    let materialData = [];
    try {
      materialData = JSON.parse($('#material_data').value || '[]');
    } catch (e) {
      console.error('Error parsing material data:', e);
    }
    
    if (materialData.length > 0) {
      materialData.forEach(item => {
        const materialText = item.materialText;
        const quantity = item.menge;
        
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td>${materialText}</td>
          <td>${quantity}</td>
        `;
        materialPreview.appendChild(newRow);
      });
    } else {
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = `
        <td colspan="2" class="text-center text-muted">Keine Materialien eingetragen</td>
      `;
      materialPreview.appendChild(emptyRow);
    }
    
    // Notes
    const notes = $('#{{ form.notes.id }}').value.trim();
    $('#preview-notes-section').style.display = notes ? 'block' : 'none';
    $('#preview-notes').textContent = notes;
  }
  
  // Setup autosave
  function setupAutosave() {
    const AUTOSAVE_KEY = 'timesheet_autosave_' + window.location.pathname;
    const AUTOSAVE_INTERVAL = 30000; // 30 seconds
    
    // Restore data from autosave
    try {
      const savedData = localStorage.getItem(AUTOSAVE_KEY);
      if (savedData) {
        const data = JSON.parse(savedData);
        
        // Restore header data
        if (data.date) $('#datum').value = data.date;
        if (data.arbeitskraft) $('#arbeitskraft').value = data.arbeitskraft;
        if (data.an_abreise) $('#an_abreise').value = data.an_abreise;
        
        // Restore timesheet data
        if (data.arbeitseinsatz && data.arbeitseinsatz.length > 0) {
          // First row
          const firstRow = $('#arbeitseinsatz-table tbody tr');
          firstRow.querySelector('.activity-select').value = data.arbeitseinsatz[0].activity;
          firstRow.querySelector('.time-from').value = data.arbeitseinsatz[0].von;
          firstRow.querySelector('.time-to').value = data.arbeitseinsatz[0].bis;
          
          // Additional rows
          for (let i = 1; i < data.arbeitseinsatz.length; i++) {
            addTimeRow();
            const row = $$('#arbeitseinsatz-table tbody tr')[i];
            row.querySelector('.activity-select').value = data.arbeitseinsatz[i].activity;
            row.querySelector('.time-from').value = data.arbeitseinsatz[i].von;
            row.querySelector('.time-to').value = data.arbeitseinsatz[i].bis;
          }
        }
        
        // Restore material data
        if (data.material && data.material.length > 0) {
          // First row
          const firstRow = $('#material-table tbody tr');
          firstRow.querySelector('.material-name').value = data.material[0].material;
          firstRow.querySelector('.material-quantity').value = data.material[0].menge;
          
          // Additional rows
          for (let i = 1; i < data.material.length; i++) {
            addMaterialRow();
            const row = $$('#material-table tbody tr')[i];
            row.querySelector('.material-name').value = data.material[i].material;
            row.querySelector('.material-quantity').value = data.material[i].menge;
          }
        }
        
        // Restore notes
        if (data.notes) $('#{{ form.notes.id }}').value = data.notes;
        
        // Update UI
        updateAllHours();
        checkForOtherActivity();
        checkForOtherMaterial();
        
        // Show autosave notification
        showAutosaveNotification();
      }
    } catch (error) {
      console.error('Error restoring autosave data:', error);
    }
    
    // Set autosave interval
    setInterval(() => {
      try {
        const data = {
          date: $('#datum').value,
          arbeitskraft: $('#arbeitskraft').value,
          an_abreise: $('#an_abreise').value,
          arbeitseinsatz: JSON.parse($('#arbeitseinsatz_data').value || '[]'),
          material: JSON.parse($('#material_data').value || '[]'),
          notes: $('#{{ form.notes.id }}').value
        };
        
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
      } catch (error) {
        console.error('Autosave error:', error);
      }
    }, AUTOSAVE_INTERVAL);
    
    // Clear autosave on form submission
    $('#timesheet-form').addEventListener('submit', function() {
      localStorage.removeItem(AUTOSAVE_KEY);
    });
  }
  
  function showAutosaveNotification() {
    const autosaveInfo = document.createElement('div');
    autosaveInfo.className = 'alert alert-info animate__animated animate__fadeIn';
    autosaveInfo.innerHTML = `
      <i class="fas fa-history me-2"></i>
      <strong>Automatisch gespeicherte Daten wiederhergestellt.</strong>
      <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Schließen"></button>
    `;
    $('.card-body').insertBefore(autosaveInfo, $('form'));
    
    setTimeout(() => {
      autosaveInfo.classList.add('animate__fadeOut');
      setTimeout(() => autosaveInfo.remove(), 500);
    }, 5000);
  }
  
  // Setup event listeners
  function setupEventListeners() {
    // Form inputs
    $$('#timesheet-form input, #timesheet-form select, #timesheet-form textarea').forEach(input => {
      input.addEventListener('input', updateJsonData);
    });
    
    // Time inputs
    $$('.time-from, .time-to').forEach(input => {
      input.addEventListener('change', updateAllHours);
    });
    
    // Activity selects
    $$('.activity-select').forEach(select => {
      select.addEventListener('change', checkForOtherActivity);
    });
    
    // Add row buttons
    $('#add-row-btn').addEventListener('click', addTimeRow);
    $('#add-material-btn').addEventListener('click', addMaterialRow);
    
    // Material inputs
    $$('.material-name, .material-quantity').forEach(input => {
      input.addEventListener('input', updateJsonData);
    });
    
    // Preview modal
    $('#previewModal').addEventListener('show.bs.modal', updatePreview);
  }
  
  // Setup character counter for notes
  function setupCharCounter() {
    const notesField = $('#{{ form.notes.id }}');
    const charCounter = $('#char-count');
    
    notesField.addEventListener('input', function() {
      const length = this.value.length;
      charCounter.textContent = length;
      
      charCounter.classList.toggle('text-danger', length > 500);
      charCounter.classList.toggle('text-muted', length <= 500);
    });
  }
  
  // Setup keyboard shortcuts
  function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(event) {
      // Ctrl+S to save
      if (event.ctrlKey && event.key === 's') {
        event.preventDefault();
        $('#save-btn').click();
      }
      
      // Ctrl+P for preview
      if (event.ctrlKey && event.key === 'p') {
        event.preventDefault();
        $('[data-bs-target="#previewModal"]').click();
      }
    });
  }
  
// Setup form validation with additional PDF generation preparation
function setupFormValidation() {
  const form = $('#timesheet-form');
  
  form.addEventListener('submit', function(event) {
    // Validate date
    const datumInput = $('#datum');
    if (!datumInput.value) {
      event.preventDefault();
      datumInput.classList.add('is-invalid');
      datumInput.focus();
      return;
    }
    
    // Validate worker name
    const arbeitskraftInput = $('#arbeitskraft');
    if (!arbeitskraftInput.value.trim()) {
      event.preventDefault();
      arbeitskraftInput.classList.add('is-invalid');
      arbeitskraftInput.focus();
      return;
    }
    
    // Validate hours
    const totalHours = parseFloat($('.total-hours').value);
    if (totalHours <= 0) {
      event.preventDefault();
      alert('Bitte tragen Sie mindestens eine Tätigkeit mit gültiger Zeiterfassung ein.');
      return;
    }
    
    // Validate 'Other activity' if selected
    const hasOtherActivity = Array.from($$('.activity-select')).some(select => select.value === 'andere');
    if (hasOtherActivity) {
      const otherActivityInput = $('#{{ form.other_activity.id }}');
      if (!otherActivityInput.value.trim()) {
        event.preventDefault();
        otherActivityInput.classList.add('is-invalid');
        otherActivityInput.focus();
        return;
      }
    }
    
    // Validate 'Other materials' if selected
    const hasOtherMaterial = Array.from($$('.material-name')).some(select => select.value === 'other');
    if (hasOtherMaterial) {
      const otherMaterialInput = $('#{{ form.other_material.id }}');
      if (!otherMaterialInput.value.trim()) {
        event.preventDefault();
        otherMaterialInput.classList.add('is-invalid');
        otherMaterialInput.focus();
        return;
      }
    }
    
    // Ensure material data has display text in 'material' field for PDF
    try {
      // Just make sure we have the latest data
      updateJsonData();
    } catch (e) {
      console.error('Error updating data before submission:', e);
    }
  });
}
  
  // Setup leave confirmation dialog
  function setupLeaveConfirmation() {
    let formChanged = false;
    
    // Watch for changes
    const formInputs = $$('input, select, textarea');
    formInputs.forEach(input => {
      input.addEventListener('change', function() {
        formChanged = true;
      });
    });
    
    // Show confirmation dialog
    window.addEventListener('beforeunload', function(event) {
      if (formChanged) {
        event.preventDefault();
        event.returnValue = 'Sie haben ungespeicherte Änderungen. Möchten Sie die Seite wirklich verlassen?';
        return event.returnValue;
      }
    });
    
    // Disable confirmation for cancel button
    $('a.btn-outline-secondary').addEventListener('click', function() {
      formChanged = false;
    });
    
    // Disable confirmation for save button
    $('#save-btn').addEventListener('click', function() {
      formChanged = false;
    });
  }
  
  // Set date to today
  function setDateToday() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    
    const datumInput = $('#datum');
    if (!datumInput.value) {
      datumInput.value = `${year}-${month}-${day}`;
    }
  }
  
  // Setup time field autocomplete
  function setupTimeAutocomplete() {
    const commonStartTimes = ['07:00', '07:30', '08:00', '08:30', '09:00'];
    const commonEndTimes = ['16:00', '16:30', '17:00', '17:30', '18:00'];
    
    // Create datalists if they don't exist
    if (!$('#time-from-options')) {
      createDatalist('time-from-options', commonStartTimes);
    }
    
    if (!$('#time-to-options')) {
      createDatalist('time-to-options', commonEndTimes);
    }
  }
  
  function createDatalist(id, options) {
    const datalist = document.createElement('datalist');
    datalist.id = id;
    
    options.forEach(value => {
      const option = document.createElement('option');
      option.value = value;
      datalist.appendChild(option);
    });
    
    document.body.appendChild(datalist);
  }
  
  // Apply dark theme to form elements
  function applyDarkStyles(container = document) {
    const elements = container.querySelectorAll('.form-control, .form-select');
    elements.forEach(el => {
      el.style.setProperty('background-color', '#14304d', 'important');
      el.style.setProperty('color', 'var(--accent)', 'important');
    });
  }
  
  // Make worker field editable
  function setupEditableWorkerField() {
    const arbeitskraftField = $('#arbeitskraft');
    
    arbeitskraftField.removeAttribute('readonly');
    arbeitskraftField.style.backgroundColor = "#fff";
    arbeitskraftField.style.cursor = "text";
    arbeitskraftField.placeholder = "Name(n) der Arbeitskraft(e) eingeben";
    arbeitskraftField.tabIndex = 0;
    
    const helpText = document.createElement('div');
    helpText.className = 'form-text';
    helpText.innerHTML = '<small>Mehrere Namen können mit Komma getrennt werden.</small>';
    arbeitskraftField.parentNode.appendChild(helpText);
  }
  
  // Hide fields that should be hidden
  function ensureHiddenFields() {
    ['arbeitseinsatz_data', 'material_data', 'activity-hidden', 'material-hidden'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.style.display = 'none';
        element.style.position = 'absolute';
        element.style.left = '-9999px';
      }
    });
  }
  // Mobile Responsive JavaScript Fixes

// Function to optimize display for mobile devices
function optimizeMobileDisplay() {
  const isMobile = window.innerWidth < 768;
  
  if (isMobile) {
    // Enhance dropdown text visibility and display
    document.querySelectorAll('.form-select').forEach(select => {
      // Make sure first option is not empty or just spaces
      if (select.options[0].text.trim() === '') {
        select.options[0].text = 'Auswählen';
      }
      
      // Add aria-label if not present
      if (!select.getAttribute('aria-label')) {
        const nearestLabel = select.closest('.form-group').querySelector('label');
        if (nearestLabel) {
          select.setAttribute('aria-label', nearestLabel.textContent.trim());
        }
      }
    });
    
    // Make delete buttons more visible
    document.querySelectorAll('.delete-row-btn, .delete-material-btn').forEach(btn => {
      if (!btn.querySelector('i.fas')) {
        // If using text, replace with icon
        if (btn.textContent.trim().toLowerCase().includes('löschen')) {
          btn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        }
      }
      btn.classList.add('btn-danger');
      btn.setAttribute('aria-label', 'Löschen');
    });
    
    // Optimize preview modal for mobile view
    const previewModal = document.getElementById('previewModal');
    if (previewModal) {
      // Simplify preview content if needed
      adjustPreviewForMobile();
    }
    
    // Make sure tables don't overflow
    document.querySelectorAll('table').forEach(table => {
      const wrapper = document.createElement('div');
      wrapper.className = 'table-responsive';
      table.parentNode.insertBefore(wrapper, table);
      wrapper.appendChild(table);
    });
  }
}

// Function to make the preview modal more mobile-friendly
function adjustPreviewForMobile() {
  // Add event listener to modal open
  $('#previewModal').addEventListener('show.bs.modal', function() {
    const isMobile = window.innerWidth < 768;
    
    if (isMobile) {
      // Scale down content
      document.querySelector('.preview-content').style.transform = 'scale(0.9)';
      document.querySelector('.preview-content').style.transformOrigin = 'top center';
      
      // Update preview header to be more compact
      const header = document.querySelector('#previewModal .modal-header');
      if (header) {
        header.classList.add('py-2');
      }
      
      // Add scrollable class to modal body if not present
      const modalBody = document.querySelector('#previewModal .modal-body');
      if (modalBody && !modalBody.classList.contains('modal-body-scrollable')) {
        modalBody.classList.add('modal-body-scrollable');
        modalBody.style.maxHeight = '70vh';
        modalBody.style.overflowY = 'auto';
      }
    } else {
      // Reset for desktop
      document.querySelector('.preview-content').style.transform = '';
      document.querySelector('.modal-body').style.maxHeight = '';
    }
  });
}

// Function to enhance form controls on mobile
function enhanceFormControls() {
  const isMobile = window.innerWidth < 768;
  
  if (isMobile) {
    // Enhance form field visibility
    document.querySelectorAll('.form-control, .form-select').forEach(field => {
      field.classList.add('mobile-enhanced');
      
      // Show field labels on focus for better context
      field.addEventListener('focus', function() {
        const label = this.closest('.form-group').querySelector('label');
        if (label) {
          label.classList.add('label-active');
        }
      });
      
      field.addEventListener('blur', function() {
        const label = this.closest('.form-group').querySelector('label');
        if (label) {
          label.classList.remove('label-active');
        }
      });
    });
    
    // Make buttons more tappable
    document.querySelectorAll('.btn').forEach(btn => {
      if (!btn.classList.contains('btn-icon') && !btn.classList.contains('btn-close')) {
        btn.classList.add('mobile-button');
      }
    });
    
    // Enhance visibility of time inputs
    document.querySelectorAll('.time-from, .time-to').forEach(input => {
      input.addEventListener('focus', function() {
        this.closest('td').classList.add('active-cell');
      });
      
      input.addEventListener('blur', function() {
        this.closest('td').classList.remove('active-cell');
      });
    });
  }
}

// Function to improve visibility of dropdown selection
function improveDropdownVisibility() {
  document.querySelectorAll('.form-select').forEach(select => {
    select.addEventListener('change', function() {
      if (this.value) {
        this.classList.add('has-value');
      } else {
        this.classList.remove('has-value');
      }
    });
    
    // Initialize on load
    if (select.value) {
      select.classList.add('has-value');
    }
  });
}

// Add these functions to window.onload
window.addEventListener('DOMContentLoaded', function() {
  optimizeMobileDisplay();
  enhanceFormControls();
  improveDropdownVisibility();
  
  // Re-run on resize
  window.addEventListener('resize', function() {
    optimizeMobileDisplay();
    enhanceFormControls();
  });
});
  
  // Initialize everything
  function init() {
    setupEditableWorkerField();
    setupEventListeners();
    setupCharCounter();
    setupKeyboardShortcuts();
    setupFormValidation();
    setupLeaveConfirmation();
    setDateToday();
    setupTimeAutocomplete();
    setupAutosave();
    ensureHiddenFields();
    applyDarkStyles();
    
    // Initialize state
    updateAllHours();
    updateJsonData();
    updateRemoveButtons();
    updateMaterialRemoveButtons();
    checkForOtherActivity();
    checkForOtherMaterial();
    
    // Setup MutationObserver for dark theme
    const observer = new MutationObserver(mutations => {
      mutations.forEach(mutation => {
        if (mutation.addedNodes) {
          mutation.addedNodes.forEach(node => {
            if (node.querySelectorAll) {
              applyDarkStyles(node);
            }
          });
        }
      });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
  }
  
  // Run initialization
  init();
});
</script>
{% endblock %}
